<!DOCTYPE html>
<html class="light" lang="ru">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>–ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π - –ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</title>

    <link href="{{ url_for('static', filename='css/output.css') }}" rel="stylesheet"/>
    <script src="{{ url_for('static', filename='js/auth.js') }}"></script>
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

    <style>
        /* Quill @ button */
        .ql-mention-employee {
            font-weight: bold !important;
            font-size: 18px !important;
            line-height: 1 !important;
        }
        .ql-mention-employee:hover {
            color: #3b82f6 !important;
        }

        /* Employee modal scrollbar */
        #employeesList::-webkit-scrollbar {
            width: 8px;
        }
        #employeesList::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.1);
            border-radius: 4px;
        }
        #employeesList::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 4px;
        }
        #employeesList::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 0, 0, 0.5);
        }

        /* Collapsible sidebar */
        .sidebar-expanded {
            width: 16rem;
        }
        .sidebar-collapsed {
            width: 4.5rem;
        }
        .sidebar-collapsed .sidebar-text {
            display: none;
        }
        .sidebar-text {
            transition: opacity 0.2s ease-in-out;
        }
        .sidebar-collapsed .sidebar-text {
            opacity: 0;
        }
        #sidebar.sidebar-collapsed > div > div:first-child > div:first-child {
            justify-content: center !important;
        }
        #sidebar.sidebar-collapsed nav a {
            justify-content: center !important;
            padding-left: 0 !important;
            padding-right: 0 !important;
        }
    </style>
</head>

<body class="font-display bg-background-light dark:bg-background-dark text-[#1F2937] dark:text-gray-200">
<div class="flex min-h-screen">
    <aside id="sidebar" class="sidebar-expanded bg-white dark:bg-[#182431] border-r border-gray-200 dark:border-gray-700 p-4 transition-all duration-300">
        <div class="flex flex-col h-full">
            <div class="mb-6">
                <div class="flex items-center gap-3 mb-3">
                    <div class="bg-primary rounded-lg size-10 flex items-center justify-center flex-shrink-0">
                        <span class="material-symbols-outlined text-white">support_agent</span>
                    </div>
                    <h1 class="sidebar-text text-lg font-bold text-gray-800 dark:text-white whitespace-nowrap overflow-hidden">–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</h1>
                </div>
                <button onclick="toggleSidebar()" class="w-full flex items-center justify-center gap-2 py-2 rounded-lg bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors" title="–°–≤–µ—Ä–Ω—É—Ç—å/—Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—å –º–µ–Ω—é">
                    <span class="material-symbols-outlined text-gray-600 dark:text-gray-400 text-xl">menu</span>
                    <span class="sidebar-text text-sm font-medium text-gray-600 dark:text-gray-400">–°–≤–µ—Ä–Ω—É—Ç—å –º–µ–Ω—é</span>
                </button>
            </div>

            <nav class="flex flex-col gap-2 flex-grow">
                <a class="nav-link flex items-center gap-3 px-3 py-2 rounded-lg bg-primary/20 dark:bg-primary/30 text-primary dark:text-white" href="./" title="–ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π">
                    <span class="material-symbols-outlined fill flex-shrink-0">import_contacts</span>
                    <p class="sidebar-text text-sm font-bold leading-normal whitespace-nowrap overflow-hidden">–ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π</p>
                </a>
                <a class="nav-link flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700/50 transition-colors" href="./logs" title="–õ–æ–≥–∏">
                    <span class="material-symbols-outlined text-gray-600 dark:text-gray-400 flex-shrink-0">receipt_long</span>
                    <p class="sidebar-text text-gray-800 dark:text-gray-200 text-sm font-medium leading-normal whitespace-nowrap overflow-hidden">–õ–æ–≥–∏</p>
                </a>
                <a class="nav-link flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700/50 transition-colors" href="./test-periods" title="–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ">
                    <span class="material-symbols-outlined text-gray-600 dark:text-gray-400 flex-shrink-0">science</span>
                    <p class="sidebar-text text-gray-800 dark:text-gray-200 text-sm font-medium leading-normal whitespace-nowrap overflow-hidden">–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</p>
                </a>
                <a class="nav-link flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700/50 transition-colors" href="./permissions" title="–ü—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞">
                    <span class="material-symbols-outlined text-gray-600 dark:text-gray-400 flex-shrink-0">admin_panel_settings</span>
                    <p class="sidebar-text text-gray-800 dark:text-gray-200 text-sm font-medium leading-normal whitespace-nowrap overflow-hidden">–ü—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞</p>
                </a>
                <a class="nav-link flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700/50 transition-colors" href="./settings" title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏">
                    <span class="material-symbols-outlined text-gray-600 dark:text-gray-400 flex-shrink-0">settings</span>
                    <p class="sidebar-text text-gray-800 dark:text-gray-200 text-sm font-medium leading-normal whitespace-nowrap overflow-hidden">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</p>
                </a>
            </nav>
        </div>
    </aside>

    <main class="flex-1 p-6 lg:p-10">
        <div class="max-w-7xl mx-auto">
            <div class="flex flex-wrap justify-between items-center gap-4 mb-8">
                <div class="flex flex-col gap-1">
                    <h1 class="text-gray-800 dark:text-white text-3xl font-bold leading-tight">–ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π</h1>
                    <p class="text-gray-500 dark:text-gray-400 text-base font-normal leading-normal">–£–ø—Ä–∞–≤–ª—è–π—Ç–µ –≤–æ–ø—Ä–æ—Å–∞–º–∏ –∏ –æ—Ç–≤–µ—Ç–∞–º–∏ –¥–ª—è —á–∞—Ç-–±–æ—Ç–∞.</p>
                </div>
                <div class="flex gap-3">
                    <button onclick="openAddModal()" class="flex items-center justify-center gap-2 rounded-lg h-11 px-5 bg-primary text-white text-sm font-bold shadow-sm hover:bg-primary/90 transition-colors">
                        <span class="material-symbols-outlined text-xl">add_circle</span>
                        <span class="truncate">–î–æ–±–∞–≤–∏—Ç—å FAQ</span>
                    </button>
                    <button onclick="retrainModel()" class="flex items-center justify-center gap-2 rounded-lg h-11 px-5 bg-yellow-500 text-white text-sm font-bold shadow-sm hover:bg-yellow-600 transition-colors">
                        <span class="material-symbols-outlined text-xl">refresh</span>
                        <span class="truncate">–ü–µ—Ä–µ–æ–±—É—á–∏—Ç—å</span>
                    </button>
                </div>
            </div>

            <div class="bg-white dark:bg-[#182431] rounded-xl shadow-md border border-gray-200 dark:border-gray-700 p-6 mb-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-gray-800 dark:text-white text-lg font-semibold">–ü–æ–∏—Å–∫ FAQ</h3>
                    <div class="flex items-center gap-4">
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="radio" name="searchType" value="text" checked class="w-4 h-4 text-primary">
                            <span class="text-sm text-gray-700 dark:text-gray-300">–¢–µ–∫—Å—Ç–æ–≤—ã–π</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="radio" name="searchType" value="semantic" class="w-4 h-4 text-primary">
                            <span class="text-sm text-gray-700 dark:text-gray-300">–°–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–π (AI)</span>
                        </label>
                    </div>
                </div>

                <div class="flex gap-3 mb-4">
                    <div class="flex-1 flex items-stretch rounded-lg bg-gray-50 dark:bg-gray-700/50 border border-gray-200 dark:border-gray-600">
                        <div class="text-gray-400 flex items-center justify-center pl-4">
                            <span class="material-symbols-outlined">search</span>
                        </div>
                        <input
                            type="text"
                            id="searchQuery"
                            class="form-input flex-1 bg-transparent border-none focus:ring-0 text-gray-800 dark:text-gray-200 placeholder:text-gray-400"
                            placeholder="–ù–∞–π—Ç–∏ –≤–æ–ø—Ä–æ—Å..."
                            onkeypress="if(event.key==='Enter') performSearch()"
                        >
                    </div>
                    <button onclick="performSearch()" class="flex items-center gap-2 px-5 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors">
                        <span class="material-symbols-outlined">search</span>
                        <span>–ò—Å–∫–∞—Ç—å</span>
                    </button>
                    <button onclick="clearSearch()" class="flex items-center gap-2 px-5 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors">
                        <span class="material-symbols-outlined">close</span>
                        <span>–û—á–∏—Å—Ç–∏—Ç—å</span>
                    </button>
                </div>

                <div id="searchInfo" style="display: none;" class="p-3 bg-blue-50 dark:bg-blue-900/20 border-l-4 border-primary rounded text-sm text-gray-700 dark:text-gray-300"></div>
            </div>

            <div class="mb-6 flex flex-col sm:flex-row gap-4 items-center">
                <div class="flex-grow w-full">
                    <select id="categoryFilter" onchange="applyFilters()" class="form-select w-full rounded-lg bg-white dark:bg-gray-700/50 h-12 shadow-sm border border-gray-200 dark:border-gray-600 focus:ring-primary focus:border-primary">
                        <option value="">–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>
                        {% for cat in categories %}
                        <option value="{{ cat }}">{{ cat }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="relative">
                    <button onclick="toggleExportMenu()" class="flex items-center gap-2 px-4 h-12 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors shadow-sm">
                        <span class="material-symbols-outlined">download</span>
                        <span class="text-sm font-medium">–≠–∫—Å–ø–æ—Ä—Ç</span>
                        <span class="material-symbols-outlined text-xl">expand_more</span>
                    </button>

                    <div id="exportMenu" class="hidden absolute right-0 mt-2 w-64 bg-white dark:bg-gray-800 rounded-lg shadow-lg border border-gray-200 dark:border-gray-600 z-50">
                        <div class="p-3">
                            <p class="text-xs font-medium text-gray-500 dark:text-gray-400 mb-2 uppercase">–§–æ—Ä–º–∞—Ç —ç–∫—Å–ø–æ—Ä—Ç–∞</p>
                            <button onclick="exportForReview('excel')" class="w-full flex items-center gap-3 px-4 py-3 text-left hover:bg-gray-50 dark:hover:bg-gray-700 rounded-lg transition-colors">
                                <span class="material-symbols-outlined text-green-600 dark:text-green-400">table_chart</span>
                                <div>
                                    <p class="text-sm font-medium text-gray-800 dark:text-gray-200">Excel (.xlsx)</p>
                                    <p class="text-xs text-gray-500 dark:text-gray-400">–î–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</p>
                                </div>
                            </button>
                            <button onclick="exportForReview('pdf')" class="w-full flex items-center gap-3 px-4 py-3 text-left hover:bg-gray-50 dark:hover:bg-gray-700 rounded-lg transition-colors">
                                <span class="material-symbols-outlined text-red-600 dark:text-red-400">picture_as_pdf</span>
                                <div>
                                    <p class="text-sm font-medium text-gray-800 dark:text-gray-200">PDF</p>
                                    <p class="text-xs text-gray-500 dark:text-gray-400">–î–ª—è –ø–µ—á–∞—Ç–∏</p>
                                </div>
                            </button>
                        </div>
                        <div class="border-t border-gray-200 dark:border-gray-600 p-3">
                            <p class="text-xs text-gray-500 dark:text-gray-400">
                                <span class="material-symbols-outlined text-sm align-middle">info</span>
                                –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è —Ç–µ–∫—É—â–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è
                            </p>
                        </div>
                    </div>
                </div>

                <div class="flex items-center gap-2">
                    <p class="text-sm font-medium text-gray-600 dark:text-gray-400 shrink-0">–í–∏–¥:</p>
                    <div class="flex items-center bg-gray-200 dark:bg-gray-700/50 p-1 rounded-lg">
                        <button id="viewListBtn" onclick="setView('list')" class="p-1.5 rounded-md text-gray-500 dark:text-gray-400 hover:bg-white/50 dark:hover:bg-gray-800/50">
                            <span class="material-symbols-outlined">view_list</span>
                        </button>
                        <button id="viewGridBtn" onclick="setView('grid')" class="p-1.5 rounded-md bg-white dark:bg-gray-800 text-primary dark:text-white shadow">
                            <span class="material-symbols-outlined">grid_view</span>
                        </button>
                    </div>
                </div>
            </div>

            <div id="faqListContainer">
                <div id="gridView" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
                    <div class="text-center py-12 text-gray-500">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                </div>

                <div id="listView" class="bg-white dark:bg-[#182431] rounded-xl shadow-md overflow-hidden border border-gray-200 dark:border-gray-700" style="display: none;">
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead class="bg-gray-50 dark:bg-gray-700/50">
                                <tr>
                                    <th class="px-6 py-4 text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider w-2/5">–í–æ–ø—Ä–æ—Å</th>
                                    <th class="px-6 py-4 text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider w-2/5">–û—Ç–≤–µ—Ç (–∫—Ä–∞—Ç–∫–æ)</th>
                                    <th class="px-6 py-4 text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th>
                                    <th class="px-6 py-4 text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider">–î–µ–π—Å—Ç–≤–∏—è</th>
                                </tr>
                            </thead>
                            <tbody id="listViewBody" class="divide-y divide-gray-200 dark:divide-gray-700">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>

<div id="faqModal" class="fixed inset-0 bg-black/70 z-50 items-center justify-center" style="display: none;">
    <div class="bg-white dark:bg-[#182431] rounded-xl shadow-xl p-8 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
        <h2 class="text-2xl font-bold text-gray-800 dark:text-white mb-6" id="modalTitle">–î–æ–±–∞–≤–∏—Ç—å FAQ</h2>
        <form id="faqForm">
            <input type="hidden" id="faqId">

            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">–ö–∞—Ç–µ–≥–æ—Ä–∏—è *</label>
                <div class="flex gap-2">
                    <select id="faqCategory" required class="flex-1 form-select rounded-lg border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white">
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é</option>
                    </select>
                    <button type="button" onclick="openCategoryModal()" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 text-xl font-bold">+</button>
                </div>
            </div>

            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">–í–æ–ø—Ä–æ—Å *</label>
                <input type="text" id="faqQuestion" required class="w-full form-input rounded-lg border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white">
            </div>

            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">–û—Ç–≤–µ—Ç *</label>
                <div id="faqAnswerEditor" class="wysiwyg-editor"></div>
                <textarea id="faqAnswer" required style="display: none;"></textarea>
            </div>

            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">–ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)</label>
                <div class="flex gap-2">
                    <input type="text" id="faqKeywords" class="flex-1 form-input rounded-lg border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white" placeholder="—Å–ª–æ–≤–æ1, —Å–ª–æ–≤–æ2, —Å–ª–æ–≤–æ3">
                    <button type="button" onclick="optimizeKeywords()" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors flex items-center gap-2 whitespace-nowrap" title="–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ (—É–±—Ä–∞—Ç—å –¥—É–±–ª–∏–∫–∞—Ç—ã —Ñ–æ—Ä–º)">
                        <span class="material-symbols-outlined text-xl">auto_fix_high</span>
                        <span class="hidden sm:inline">–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å</span>
                    </button>
                </div>
                <p class="flex items-center gap-1 text-xs text-gray-500 dark:text-gray-400 mt-1">
                    <span class="material-symbols-outlined text-sm">info</span>
                    <span>–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–∏–≤–æ–¥–∏—Ç —Å–ª–æ–≤–∞ –∫ –Ω–∞—á–∞–ª—å–Ω–æ–π —Ñ–æ—Ä–º–µ –∏ —É–¥–∞–ª—è–µ—Ç –¥—É–±–ª–∏–∫–∞—Ç—ã (–ø—Ä–µ—Ç–µ–Ω–∑–∏—é, –ø—Ä–µ—Ç–µ–Ω–∑–∏–∏ ‚Üí –ø—Ä–µ—Ç–µ–Ω–∑–∏—è)</span>
                </p>
            </div>

            <div class="flex gap-3 justify-end">
                <button type="button" onclick="closeModal()" class="px-5 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors">–û—Ç–º–µ–Ω–∞</button>
                <button type="submit" class="px-5 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </form>
    </div>
</div>

<div id="categoryModal" class="fixed inset-0 bg-black/70 z-50 items-center justify-center" style="display: none;">
    <div class="bg-white dark:bg-[#182431] rounded-xl shadow-xl p-6 max-w-md w-full mx-4">
        <h3 class="text-xl font-bold text-gray-800 dark:text-white mb-4">–î–æ–±–∞–≤–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é</h3>
        <input type="text" id="newCategoryName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏" class="w-full form-input rounded-lg border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white mb-4">
        <div class="flex gap-3 justify-end">
            <button type="button" onclick="closeCategoryModal()" class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600">–û—Ç–º–µ–Ω–∞</button>
            <button type="button" onclick="saveCategory()" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
    </div>
</div>

<div id="mentionEmployeeModal" class="fixed inset-0 bg-black/70 items-center justify-center" style="display: none; z-index: 9999;" onclick="if(event.target === this) closeMentionEmployeeModal()">
    <div class="bg-white dark:bg-[#182431] rounded-xl shadow-xl p-4 max-w-xl w-full mx-4 flex flex-col" style="max-height: 500px;">
        <div class="flex items-center justify-between mb-3 pb-3 border-b border-gray-200 dark:border-gray-700">
            <h3 class="text-lg font-bold text-gray-800 dark:text-white">@ –£–ø–æ–º—è–Ω—É—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞</h3>
            <button onclick="closeMentionEmployeeModal()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 transition-colors">
                <span class="material-symbols-outlined text-2xl">close</span>
            </button>
        </div>

        <div class="mb-3">
            <input type="text" id="employeeSearch" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏..." class="w-full px-3 py-2 rounded-lg border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white text-sm" onkeyup="filterEmployees()">
        </div>

        <div id="employeesLoading" class="text-center py-8">
            <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-primary"></div>
            <p class="mt-2 text-gray-600 dark:text-gray-400 text-sm">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤...</p>
        </div>

        <div id="employeesList" class="flex-1 overflow-y-auto mb-3 hidden" style="min-height: 200px; max-height: 350px;"></div>

        <div id="employeesError" class="hidden text-center py-8">
            <p class="text-red-600 dark:text-red-400 text-sm" id="employeesErrorMessage"></p>
            <button onclick="loadEmployeesForMention()" class="mt-4 px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors text-sm">
                –ü–æ–≤—Ç–æ—Ä–∏—Ç—å –ø–æ–ø—ã—Ç–∫—É
            </button>
        </div>
    </div>
</div>

<script>
    const BASE_URL = '{{ config.get("BASE_PATH", "") }}/admin';

    let currentEditId = null;
    let isSearchActive = false;
    let currentSearchData = null;
    let answerEditor = null;
    let currentView = localStorage.getItem('faqView') || 'grid';

    let allEmployees = [];
    let filteredEmployees = [];
    let quillEditorForMention = null;
    let loadingEmployees = false;

    function setView(view) {
        currentView = view;
        localStorage.setItem('faqView', view);

        const gridView = document.getElementById('gridView');
        const listView = document.getElementById('listView');
        const gridBtn = document.getElementById('viewGridBtn');
        const listBtn = document.getElementById('viewListBtn');

        if (view === 'grid') {
            gridView.style.display = 'grid';
            listView.style.display = 'none';
            gridBtn.classList.add('bg-white', 'dark:bg-gray-800', 'text-primary', 'dark:text-white', 'shadow');
            gridBtn.classList.remove('text-gray-500', 'dark:text-gray-400');
            listBtn.classList.remove('bg-white', 'dark:bg-gray-800', 'text-primary', 'dark:text-white', 'shadow');
            listBtn.classList.add('text-gray-500', 'dark:text-gray-400');
        } else {
            gridView.style.display = 'none';
            listView.style.display = 'block';
            listBtn.classList.add('bg-white', 'dark:bg-gray-800', 'text-primary', 'dark:text-white', 'shadow');
            listBtn.classList.remove('text-gray-500', 'dark:text-gray-400');
            gridBtn.classList.remove('bg-white', 'dark:bg-gray-800', 'text-primary', 'dark:text-white', 'shadow');
            gridBtn.classList.add('text-gray-500', 'dark:text-gray-400');
        }

        // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ —Å–º–µ–Ω–µ –≤–∏–¥–∞
        if (!isSearchActive) {
            loadFAQs(document.getElementById('categoryFilter').value);
        } else {
            displaySearchResults(currentSearchData, document.querySelector('input[name="searchType"]:checked').value);
        }
    }

    // –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤
    function applyFilters() {
        if (!isSearchActive) {
            loadFAQs(document.getElementById('categoryFilter').value);
        }
    }

    // –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è Quill HTML –≤ Telegram HTML
    function convertQuillToTelegramHtml(html) {
        html = html.replace(/<strong>/g, '<b>');
        html = html.replace(/<\/strong>/g, '</b>');
        html = html.replace(/<em>/g, '<i>');
        html = html.replace(/<\/em>/g, '</i>');
        html = html.replace(/<pre class="ql-syntax"[^>]*>/g, '<code>');
        html = html.replace(/<\/pre>/g, '</code>');
        html = html.replace(/<p><br><\/p>/g, '\n');
        html = html.replace(/<p>/g, '');
        html = html.replace(/<\/p>/g, '\n');
        html = html.replace(/<br>/g, '\n');
        html = html.replace(/<br\/>/g, '\n');
        html = html.replace(/<br \/>/g, '\n');
        html = html.replace(/\n+$/g, '');
        return html;
    }

    // –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è BB –∫–æ–¥–æ–≤ –≤ HTML –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
    function convertBBCodeToHtml(text) {
        if (!text) return '';

        let html = text;

        // –°—Å—ã–ª–∫–∏ BB ‚Üí HTML (—Å–Ω–∞—á–∞–ª–∞, —á—Ç–æ–±—ã –Ω–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤–∞—Ç—å —Å –¥—Ä—É–≥–∏–º–∏ —Ç–µ–≥–∞–º–∏)
        html = html.replace(/\[URL=([^\]]+)\](.+?)\[\/URL\]/gi, '<a href="$1" target="_blank">$2</a>');

        // –ñ–∏—Ä–Ω—ã–π
        html = html.replace(/\[b\]/gi, '<b>');
        html = html.replace(/\[\/b\]/gi, '</b>');

        // –ö—É—Ä—Å–∏–≤
        html = html.replace(/\[i\]/gi, '<i>');
        html = html.replace(/\[\/i\]/gi, '</i>');

        // –ü–æ–¥—á–µ—Ä–∫–Ω—É—Ç—ã–π
        html = html.replace(/\[u\]/gi, '<u>');
        html = html.replace(/\[\/u\]/gi, '</u>');

        // –ó–∞—á–µ—Ä–∫–Ω—É—Ç—ã–π
        html = html.replace(/\[s\]/gi, '<s>');
        html = html.replace(/\[\/s\]/gi, '</s>');

        // –ö–æ–¥
        html = html.replace(/\[code\]/gi, '<code>');
        html = html.replace(/\[\/code\]/gi, '</code>');

        // –ü–µ—Ä–µ–Ω–æ—Å—ã —Å—Ç—Ä–æ–∫
        html = html.replace(/\n/g, '<br>');

        return html;
    }

    // –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è Telegram HTML –≤ Quill HTML (—Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π BB –∫–æ–¥–æ–≤)
    function convertTelegramToQuillHtml(html) {
        if (!html) return '<p><br></p>';

        // –°–Ω–∞—á–∞–ª–∞ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º BB –∫–æ–¥—ã –≤ HTML –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
        html = convertBBCodeToHtml(html);

        // –ü–æ—Ç–æ–º –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ HTML —Ç–µ–≥–∏
        html = html.replace(/<b>/g, '<strong>');
        html = html.replace(/<\/b>/g, '</strong>');
        html = html.replace(/<i>/g, '<em>');
        html = html.replace(/<\/i>/g, '</em>');
        html = html.replace(/<code>/g, '<code class="ql-code">');

        // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –ø–µ—Ä–µ–Ω–æ—Å—ã —Å—Ç—Ä–æ–∫
        const lines = html.split(/\n|<br\s*\/?>/i);
        const paragraphs = lines.map(line => {
            if (line.trim() === '') return '<p><br></p>';
            return '<p>' + line + '</p>';
        });
        return paragraphs.join('');
    }

    // –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è Quill HTML –≤ BB –∫–æ–¥—ã –ë–∏—Ç—Ä–∏–∫—Å24
    function convertQuillToBBCode(html) {
        if (!html) return '';

        let text = html;

        // –°—Å—ã–ª–∫–∏ (–í–ê–ñ–ù–û: –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –ø–µ—Ä–≤—ã–º–∏, —á—Ç–æ–±—ã –Ω–µ –ø–æ—Ç–µ—Ä—è—Ç—å –ø—Ä–∏ –¥—Ä—É–≥–∏—Ö –∑–∞–º–µ–Ω–∞—Ö)
        text = text.replace(/<a\s+(?:[^>]*?\s+)?href=["']([^"']+)["'](?:[^>]*)>(.*?)<\/a>/gi, '[URL=$1]$2[/URL]');

        // –ñ–∏—Ä–Ω—ã–π —Ç–µ–∫—Å—Ç
        text = text.replace(/<strong>/gi, '[b]');
        text = text.replace(/<\/strong>/gi, '[/b]');
        text = text.replace(/<b>/gi, '[b]');
        text = text.replace(/<\/b>/gi, '[/b]');

        // –ö—É—Ä—Å–∏–≤
        text = text.replace(/<em>/gi, '[i]');
        text = text.replace(/<\/em>/gi, '[/i]');
        text = text.replace(/<i>/gi, '[i]');
        text = text.replace(/<\/i>/gi, '[/i]');

        // –ü–æ–¥—á—ë—Ä–∫–Ω—É—Ç—ã–π
        text = text.replace(/<u>/gi, '[u]');
        text = text.replace(/<\/u>/gi, '[/u]');

        // –ó–∞—á—ë—Ä–∫–Ω—É—Ç—ã–π
        text = text.replace(/<s>/gi, '[s]');
        text = text.replace(/<\/s>/gi, '[/s]');
        text = text.replace(/<strike>/gi, '[s]');
        text = text.replace(/<\/strike>/gi, '[/s]');
        text = text.replace(/<del>/gi, '[s]');
        text = text.replace(/<\/del>/gi, '[/s]');

        // –ö–æ–¥
        text = text.replace(/<code[^>]*>/gi, '[code]');
        text = text.replace(/<\/code>/gi, '[/code]');
        text = text.replace(/<pre[^>]*>/gi, '[code]');
        text = text.replace(/<\/pre>/gi, '[/code]');

        // –°–ø–∏—Å–∫–∏ (—É–ø–æ—Ä—è–¥–æ—á–µ–Ω–Ω—ã–µ)
        text = text.replace(/<ol[^>]*>/gi, '');
        text = text.replace(/<\/ol>/gi, '');
        text = text.replace(/<li>/gi, '‚Ä¢ ');
        text = text.replace(/<\/li>/gi, '\n');

        // –°–ø–∏—Å–∫–∏ (–Ω–µ—É–ø–æ—Ä—è–¥–æ—á–µ–Ω–Ω—ã–µ)
        text = text.replace(/<ul[^>]*>/gi, '');
        text = text.replace(/<\/ul>/gi, '');

        // –£–±–∏—Ä–∞–µ–º –æ—Å—Ç–∞–≤—à–∏–µ—Å—è HTML —Ç–µ–≥–∏
        text = text.replace(/<br\s*\/?>/gi, '\n');
        text = text.replace(/<p><br><\/p>/gi, '\n');
        text = text.replace(/<p>/gi, '');
        text = text.replace(/<\/p>/gi, '\n');
        text = text.replace(/<div>/gi, '');
        text = text.replace(/<\/div>/gi, '\n');

        // –û—á–∏—Å—Ç–∫–∞ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –ø–µ—Ä–µ–Ω–æ—Å–æ–≤ —Å—Ç—Ä–æ–∫
        text = text.replace(/\n{3,}/g, '\n\n');
        text = text.trim();

        return text;
    }

    // ========== –§–£–ù–ö–¶–ò–ò –î–õ–Ø –£–ü–û–ú–ò–ù–ê–ù–ò–ô –°–û–¢–†–£–î–ù–ò–ö–û–í ==========

    // –û—Ç–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≤—ã–±–æ—Ä–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞
    function openMentionEmployeeModal(editor) {
        quillEditorForMention = editor;
        document.getElementById('mentionEmployeeModal').style.display = 'flex';
        document.getElementById('employeeSearch').value = '';
        loadEmployeesForMention();
    }

    // –ó–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
    function closeMentionEmployeeModal() {
        document.getElementById('mentionEmployeeModal').style.display = 'none';
        quillEditorForMention = null;
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –∏–∑ Bitrix24
    async function loadEmployeesForMention() {
        if (loadingEmployees) return;

        try {
            loadingEmployees = true;
            document.getElementById('employeesLoading').classList.remove('hidden');
            document.getElementById('employeesList').classList.add('hidden');
            document.getElementById('employeesError').classList.add('hidden');

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å BX24 SDK
            if (!window.parent || !window.parent.BX24) {
                throw new Error('Bitrix24 SDK –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –æ—Ç–∫—Ä—ã—Ç–æ —á–µ—Ä–µ–∑ Bitrix24.');
            }

            allEmployees = [];

            // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–≤—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
            const firstBatch = await new Promise((resolve, reject) => {
                window.parent.BX24.callMethod('user.get', {
                    start: 0,
                    filter: { ACTIVE: true },
                    order: { LAST_NAME: 'ASC' }
                }, (result) => {
                    if (result.error()) {
                        reject(result.error());
                    } else {
                        resolve(result);
                    }
                });
            });

            const firstData = firstBatch.data();
            allEmployees.push(...firstData);

            console.log(`üì• –ó–∞–≥—Ä—É–∂–µ–Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ 1: ${firstData.length} —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤`);

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –µ—â–µ –¥–∞–Ω–Ω—ã–µ
            if (firstBatch.more && firstBatch.more()) {
                const total = firstBatch.total ? firstBatch.total() : 1000;
                const pagesNeeded = Math.ceil(total / 50) - 1;

                console.log(`üìä –í—Å–µ–≥–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤: ${total}, –Ω—É–∂–Ω–æ –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü: ${pagesNeeded}`);

                // –°–æ–∑–¥–∞–µ–º –ø–∞–∫–µ—Ç –∑–∞–ø—Ä–æ—Å–æ–≤ –¥–ª—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏
                const batchCalls = {};
                for (let i = 1; i <= Math.min(pagesNeeded, 20); i++) {
                    batchCalls[`page${i}`] = ['user.get', {
                        start: i * 50,
                        filter: { ACTIVE: true },
                        order: { LAST_NAME: 'ASC' }
                    }];
                }

                // –í—ã–ø–æ–ª–Ω—è–µ–º –ø–∞–∫–µ—Ç–Ω—ã–π –∑–∞–ø—Ä–æ—Å
                const batchResult = await new Promise((resolve) => {
                    window.parent.BX24.callBatch(batchCalls, (result) => {
                        resolve(result);
                    });
                });

                // –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ –≤—Å–µ—Ö –æ—Ç–≤–µ—Ç–æ–≤
                for (const key in batchResult) {
                    const pageResult = batchResult[key];

                    if (pageResult && typeof pageResult.error === 'function' && pageResult.error()) {
                        continue;
                    }

                    if (pageResult && typeof pageResult.data === 'function') {
                        const data = pageResult.data();
                        if (data && Array.isArray(data) && data.length > 0) {
                            allEmployees.push(...data);
                            console.log(`üì• –ó–∞–≥—Ä—É–∂–µ–Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ ${key}: ${data.length} —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤`);
                        }
                    }
                }
            }

            // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –∏–º–µ–Ω–∏
            allEmployees.sort((a, b) => {
                const nameA = `${a.LAST_NAME || ''} ${a.NAME || ''}`.toLowerCase();
                const nameB = `${b.LAST_NAME || ''} ${b.NAME || ''}`.toLowerCase();
                return nameA.localeCompare(nameB);
            });

            console.log(`‚úÖ –í—Å–µ–≥–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤: ${allEmployees.length}`);

            filteredEmployees = allEmployees;
            displayEmployees();

            document.getElementById('employeesLoading').classList.add('hidden');
            document.getElementById('employeesList').classList.remove('hidden');

        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤:', error);
            document.getElementById('employeesLoading').classList.add('hidden');
            document.getElementById('employeesError').classList.remove('hidden');
            document.getElementById('employeesErrorMessage').textContent = error.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤';
        } finally {
            loadingEmployees = false;
        }
    }

    // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –ø–æ –ø–æ–∏—Å–∫—É
    function filterEmployees() {
        const searchTerm = document.getElementById('employeeSearch').value.toLowerCase();

        if (!searchTerm) {
            filteredEmployees = allEmployees;
        } else {
            filteredEmployees = allEmployees.filter(emp => {
                const fullName = `${emp.LAST_NAME} ${emp.NAME} ${emp.SECOND_NAME || ''}`.toLowerCase();
                return fullName.includes(searchTerm);
            });
        }

        displayEmployees();
    }

    // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤
    function displayEmployees() {
        const container = document.getElementById('employeesList');

        if (filteredEmployees.length === 0) {
            container.innerHTML = '<p class="text-center text-gray-500 dark:text-gray-400 py-8 text-sm">–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>';
            return;
        }

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—á—ë—Ç—á–∏–∫
        const totalText = filteredEmployees.length !== allEmployees.length
            ? `–ü–æ–∫–∞–∑–∞–Ω–æ ${filteredEmployees.length} –∏–∑ ${allEmployees.length}`
            : `–í—Å–µ–≥–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤: ${allEmployees.length}`;

        container.innerHTML = `
            <div class="text-xs text-gray-500 dark:text-gray-400 mb-2 px-1">${totalText}</div>
            ${filteredEmployees.map(emp => {
                const lastName = emp.LAST_NAME || '';
                const firstName = emp.NAME || '';
                const secondName = emp.SECOND_NAME || '';
                const fullName = `${lastName} ${firstName} ${secondName}`.trim();

                // –ò–Ω–∏—Ü–∏–∞–ª—ã –¥–ª—è –∞–≤–∞—Ç–∞—Ä–∞ (–ø–µ—Ä–≤–∞—è –±—É–∫–≤–∞ —Ñ–∞–º–∏–ª–∏–∏ –∏ –∏–º–µ–Ω–∏)
                const initials = `${lastName.charAt(0)}${firstName.charAt(0)}`.toUpperCase() || '?';

                // –Ø—Ä–∫–∏–µ —Ü–≤–µ—Ç–∞ –¥–ª—è –∞–≤–∞—Ç–∞—Ä–∞ (inline —Å—Ç–∏–ª–∏, —Ç–∞–∫ –∫–∞–∫ Tailwind –Ω–µ –∫–æ–º–ø–∏–ª–∏—Ä—É–µ—Ç –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –∫–ª–∞—Å—Å—ã)
                const colors = [
                    '#2563eb', // blue-600
                    '#16a34a', // green-600
                    '#ea580c', // orange-600
                    '#dc2626', // red-600
                    '#9333ea', // purple-600
                    '#db2777', // pink-600
                    '#4f46e5', // indigo-600
                    '#0d9488', // teal-600
                    '#0891b2', // cyan-600
                    '#059669', // emerald-600
                    '#7c3aed', // violet-600
                    '#c026d3'  // fuchsia-600
                ];
                const colorIndex = (emp.ID || 0) % colors.length;
                const avatarBgColor = colors[colorIndex];

                return `
                    <div class="flex items-center gap-2 p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg cursor-pointer transition-colors" onclick='selectEmployee(${JSON.stringify(emp).replace(/'/g, "&apos;")})'>
                        <div class="w-10 h-10 rounded-full text-white flex items-center justify-center font-bold text-base flex-shrink-0" style="background-color: ${avatarBgColor}; line-height: 1;">
                            ${initials}
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="text-sm font-medium text-gray-800 dark:text-white truncate">${fullName}</p>
                            ${emp.WORK_POSITION ? `<p class="text-xs text-gray-500 dark:text-gray-400 truncate">${emp.WORK_POSITION}</p>` : ''}
                        </div>
                    </div>
                `;
            }).join('')}
        `;
    }

    // –í—Å—Ç–∞–≤–∫–∞ —É–ø–æ–º–∏–Ω–∞–Ω–∏—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä
    function selectEmployee(employee) {
        if (!quillEditorForMention) {
            console.error('–†–µ–¥–∞–∫—Ç–æ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω');
            return;
        }

        // –ü–æ–ª—É—á–∞–µ–º –¥–æ–º–µ–Ω Bitrix24
        const domain = window.location.hostname.includes('bitrix24') ?
            window.location.hostname :
            'b24.virtex-food.ru';  // Fallback –Ω–∞ –≤–∞—à –¥–æ–º–µ–Ω

        // –§–æ—Ä–º–∏—Ä—É–µ–º –ø–æ–ª–Ω–æ–µ –∏–º—è
        const fullName = `${employee.LAST_NAME} ${employee.NAME} ${employee.SECOND_NAME || ''}`.trim();

        // –§–æ—Ä–º–∏—Ä—É–µ–º URL –ø—Ä–æ—Ñ–∏–ª—è
        const profileUrl = `https://${domain}/company/personal/user/${employee.ID}/`;

        // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â—É—é –ø–æ–∑–∏—Ü–∏—é –∫—É—Ä—Å–æ—Ä–∞
        const range = quillEditorForMention.getSelection(true);
        const position = range ? range.index : quillEditorForMention.getLength();

        // –í—Å—Ç–∞–≤–ª—è–µ–º HTML —Å—Å—ã–ª–∫—É (Quill –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±—Ä–∞–±–æ—Ç–∞–µ—Ç –µ—ë)
        // Quill API: insertText –¥–ª—è –æ–±—ã—á–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞, –Ω–æ –¥–ª—è —Å—Å—ã–ª–∫–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º clipboard
        const mentionText = `üôçüèª‚Äç‚ôÇÔ∏è ${fullName}`;

        // –í—Å—Ç–∞–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç –∏ –¥–µ–ª–∞–µ–º –µ–≥–æ —Å—Å—ã–ª–∫–æ–π
        quillEditorForMention.insertText(position, mentionText, 'link', profileUrl);

        // –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–æ–±–µ–ª –ø–æ—Å–ª–µ —Å—Å—ã–ª–∫–∏ –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞ –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è –Ω–∞–±–æ—Ä–∞
        quillEditorForMention.insertText(position + mentionText.length, ' ');

        // –ü–µ—Ä–µ–º–µ—â–∞–µ–º –∫—É—Ä—Å–æ—Ä –ø–æ—Å–ª–µ –≤—Å—Ç–∞–≤–ª–µ–Ω–Ω–æ–π —Å—Å—ã–ª–∫–∏ –∏ –ø—Ä–æ–±–µ–ª–∞
        quillEditorForMention.setSelection(position + mentionText.length + 1);

        // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
        closeMentionEmployeeModal();

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
        showNotification(`–î–æ–±–∞–≤–ª–µ–Ω–æ —É–ø–æ–º–∏–Ω–∞–Ω–∏–µ: ${fullName}`, 'success');
    }

    // ========== –ö–û–ù–ï–¶ –§–£–ù–ö–¶–ò–ô –î–õ–Ø –£–ü–û–ú–ò–ù–ê–ù–ò–ô ==========

    // ========== –§–£–ù–ö–¶–ò–ò –î–õ–Ø –°–ê–ô–î–ë–ê–†–ê ==========

    // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–∞–π–¥–±–∞—Ä–∞ (—Å–≤–µ—Ä–Ω—É—Ç/—Ä–∞–∑–≤–µ—Ä–Ω—É—Ç)
    function toggleSidebar() {
        const sidebar = document.getElementById('sidebar');
        const isExpanded = sidebar.classList.contains('sidebar-expanded');

        if (isExpanded) {
            sidebar.classList.remove('sidebar-expanded');
            sidebar.classList.add('sidebar-collapsed');
            localStorage.setItem('sidebarState', 'collapsed');
        } else {
            sidebar.classList.remove('sidebar-collapsed');
            sidebar.classList.add('sidebar-expanded');
            localStorage.setItem('sidebarState', 'expanded');
        }
    }

    // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–∞–π–¥–±–∞—Ä–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    function restoreSidebarState() {
        const savedState = localStorage.getItem('sidebarState');
        if (savedState === 'collapsed') {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.remove('sidebar-expanded');
            sidebar.classList.add('sidebar-collapsed');
        }
    }

    // ========== –ö–û–ù–ï–¶ –§–£–ù–ö–¶–ò–ô –î–õ–Ø –°–ê–ô–î–ë–ê–†–ê ==========

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Quill —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞
    function initAnswerEditor() {
        if (answerEditor) return;

        const editorContainer = document.getElementById('faqAnswerEditor');
        if (!editorContainer) return;

        // –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –∫–∞—Å—Ç–æ–º–Ω—É—é –∫–Ω–æ–ø–∫—É –¥–ª—è —É–ø–æ–º–∏–Ω–∞–Ω–∏–π
        const toolbarOptions = [
            ['bold', 'italic', 'underline', 'strike'],
            ['code'],
            ['link'],  // –ö–Ω–æ–ø–∫–∞ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –≥–∏–ø–µ—Ä—Å—Å—ã–ª–æ–∫
            [{ 'list': 'ordered'}, { 'list': 'bullet' }],
            ['mention-employee'],  // –ö–∞—Å—Ç–æ–º–Ω–∞—è –∫–Ω–æ–ø–∫–∞ –¥–ª—è —É–ø–æ–º–∏–Ω–∞–Ω–∏–π
            ['clean']
        ];

        answerEditor = new Quill(editorContainer, {
            theme: 'snow',
            placeholder: '–í–≤–µ–¥–∏—Ç–µ –æ—Ç–≤–µ—Ç –Ω–∞ –≤–æ–ø—Ä–æ—Å...',
            modules: {
                toolbar: {
                    container: toolbarOptions,
                    handlers: {
                        'mention-employee': function() {
                            openMentionEmployeeModal(answerEditor);
                        }
                    }
                }
            }
        });

        // –î–æ–±–∞–≤–ª—è–µ–º –∏–∫–æ–Ω–∫—É –¥–ª—è –∫–∞—Å—Ç–æ–º–Ω–æ–π –∫–Ω–æ–ø–∫–∏
        const mentionButton = editorContainer.parentElement.querySelector('.ql-mention-employee');
        if (mentionButton) {
            mentionButton.innerHTML = '@';
            mentionButton.title = '–£–ø–æ–º—è–Ω—É—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞';
        }

        answerEditor.on('text-change', () => {
            const html = answerEditor.root.innerHTML;
            // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ BB –∫–æ–¥—ã –¥–ª—è Bitrix24
            const bbcode = convertQuillToBBCode(html);
            document.getElementById('faqAnswer').value = bbcode;
        });
    }

    // –ü–æ–∏—Å–∫ FAQ
    async function performSearch() {
        const query = document.getElementById('searchQuery').value.trim();
        if (!query) {
            showNotification('–í–≤–µ–¥–∏—Ç–µ –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å', 'error');
            return;
        }

        const searchType = document.querySelector('input[name="searchType"]:checked').value;
        const searchInfo = document.getElementById('searchInfo');

        searchInfo.style.display = 'block';
        searchInfo.innerHTML = '<div class="flex items-center gap-2"><span class="material-symbols-outlined animate-spin">refresh</span> –ü–æ–∏—Å–∫...</div>';

        try {
            let response;
            if (searchType === 'text') {
                response = await fetchWithAuth(`${BASE_URL}/search?q=${encodeURIComponent(query)}`);
            } else {
                response = await fetchWithAuth(`${BASE_URL}/search/semantic`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({query: query, n_results: 20})
                });
            }

            const data = await response.json();

            if (data.success) {
                isSearchActive = true;
                currentSearchData = data;
                displaySearchResults(data, searchType);
            } else {
                searchInfo.innerHTML = `<div class="text-red-600">‚ùå ${data.message}</div>`;
            }
        } catch (error) {
            searchInfo.innerHTML = `<div class="text-red-600">‚ùå –û—à–∏–±–∫–∞: ${error.message}</div>`;
        }
    }

    function displaySearchResults(data, searchType) {
        const searchInfo = document.getElementById('searchInfo');

        if (data.count === 0) {
            searchInfo.innerHTML = `üòî –ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –ø–æ –∑–∞–ø—Ä–æ—Å—É "<strong>${data.query}</strong>"`;
            document.getElementById('gridView').innerHTML = '<div class="col-span-full text-center py-12 text-gray-500">–ù–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤</div>';
            document.getElementById('listViewBody').innerHTML = '<tr><td colspan="4" class="px-6 py-12 text-center text-gray-500">–ù–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤</td></tr>';
            return;
        }

        searchInfo.innerHTML = `‚úÖ –ù–∞–π–¥–µ–Ω–æ: <strong>${data.count}</strong> —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ | –ó–∞–ø—Ä–æ—Å: "<strong>${data.query}</strong>" | –¢–∏–ø: <strong>${searchType === 'text' ? '–¢–µ–∫—Å—Ç–æ–≤—ã–π' : '–°–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–π (AI)'}</strong>`;

        if (currentView === 'grid') {
            displayGridView(data.results);
        } else {
            displayListView(data.results);
        }
    }

    function clearSearch() {
        document.getElementById('searchQuery').value = '';
        document.getElementById('searchInfo').style.display = 'none';
        isSearchActive = false;
        currentSearchData = null;
        loadFAQs(document.getElementById('categoryFilter').value);
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ FAQ
    async function loadFAQs(category = '') {
        if (isSearchActive) return;

        const url = category ? `${BASE_URL}/faq/list?category=${category}` : `${BASE_URL}/faq/list`;
        const response = await fetchWithAuth(url);
        const faqs = await response.json();

        if (faqs.length === 0) {
            document.getElementById('gridView').innerHTML = '<div class="col-span-full text-center py-12 text-gray-500">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>';
            document.getElementById('listViewBody').innerHTML = '<tr><td colspan="4" class="px-6 py-12 text-center text-gray-500">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>';
            return;
        }

        if (currentView === 'grid') {
            displayGridView(faqs);
        } else {
            displayListView(faqs);
        }
    }

    function displayGridView(faqs) {
        const colors = ['blue', 'green', 'yellow', 'indigo', 'purple', 'pink'];
        document.getElementById('gridView').innerHTML = faqs.map((faq, idx) => {
            const color = colors[idx % colors.length];
            // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º BB –∫–æ–¥—ã –≤ HTML –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
            const answerHtml = convertBBCodeToHtml(faq.answer);
            // –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è —Ç–µ–∫—Å—Ç–∞ –±–µ–∑ —Ç–µ–≥–æ–≤
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = answerHtml;
            const answerText = tempDiv.textContent || tempDiv.innerText || '';

            return `
                <div class="bg-white dark:bg-[#182431] rounded-xl shadow-md border border-gray-200 dark:border-gray-700 p-6 flex flex-col hover:shadow-lg transition-shadow duration-300">
                    <div class="flex-grow">
                        <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium bg-${color}-100 text-${color}-800 dark:bg-${color}-900/50 dark:text-${color}-300 mb-3">${faq.category}</span>
                        <h3 class="text-lg font-bold text-gray-800 dark:text-white mb-2 leading-tight">${faq.question}</h3>
                        <p class="text-gray-500 dark:text-gray-400 text-sm leading-relaxed line-clamp-2">${answerText.substring(0, 100)}...</p>
                        ${faq.keywords && faq.keywords.length > 0 ? `
                            <div class="mt-3 flex flex-wrap gap-2">
                                ${faq.keywords.map(k => `<span class="text-xs px-2 py-1 bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300 rounded">${k}</span>`).join('')}
                            </div>
                        ` : ''}
                    </div>
                    <div class="mt-6 pt-4 border-t border-gray-200 dark:border-gray-700 flex gap-3">
                        <button onclick="editFAQ('${faq.id}')" class="flex-1 flex items-center justify-center gap-2 rounded-lg h-9 px-4 bg-gray-100 dark:bg-gray-700/50 text-gray-700 dark:text-gray-300 text-sm font-medium hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors">
                            <span class="material-symbols-outlined text-lg">edit</span>
                            <span>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</span>
                        </button>
                        <button onclick="deleteFAQ('${faq.id}')" class="flex-1 flex items-center justify-center gap-2 rounded-lg h-9 px-4 bg-red-50 dark:bg-red-500/10 text-red-600 dark:text-red-400 text-sm font-medium hover:bg-red-100 dark:hover:bg-red-500/20 transition-colors">
                            <span class="material-symbols-outlined text-lg">delete</span>
                            <span>–£–¥–∞–ª–∏—Ç—å</span>
                        </button>
                    </div>
                </div>
            `;
        }).join('');
    }

    function displayListView(faqs) {
        const colors = ['blue', 'green', 'yellow', 'indigo', 'purple', 'pink'];
        document.getElementById('listViewBody').innerHTML = faqs.map((faq, idx) => {
            const color = colors[idx % colors.length];
            // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º BB –∫–æ–¥—ã –≤ HTML –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
            const answerHtml = convertBBCodeToHtml(faq.answer);
            // –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è —Ç–µ–∫—Å—Ç–∞ –±–µ–∑ —Ç–µ–≥–æ–≤
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = answerHtml;
            const answerText = tempDiv.textContent || tempDiv.innerText || '';

            return `
                <tr class="hover:bg-gray-50 dark:hover:bg-gray-800/50 transition-colors">
                    <td class="px-6 py-4 text-gray-800 dark:text-gray-200 text-sm font-medium max-w-sm truncate">${faq.question}</td>
                    <td class="px-6 py-4 text-gray-500 dark:text-gray-400 text-sm max-w-sm truncate">${answerText.substring(0, 100)}...</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-${color}-100 text-${color}-800 dark:bg-${color}-900/50 dark:text-${color}-300">${faq.category}</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <div class="flex items-center gap-4">
                            <button onclick="editFAQ('${faq.id}')" class="text-gray-500 dark:text-gray-400 hover:text-primary dark:hover:text-primary transition-colors flex items-center gap-1.5">
                                <span class="material-symbols-outlined text-xl">edit</span>
                            </button>
                            <button onclick="deleteFAQ('${faq.id}')" class="text-gray-500 dark:text-gray-400 hover:text-red-500 dark:hover:text-red-500 transition-colors flex items-center gap-1.5">
                                <span class="material-symbols-outlined text-xl">delete</span>
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        }).join('');
    }

    async function loadCategories(selectedCategory = '') {
        const select = document.getElementById('faqCategory');
        select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é</option>';

        try {
            const response = await fetchWithAuth(`${BASE_URL}/categories`);
            if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π');

            const categories = await response.json();
            categories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat;
                option.textContent = cat;
                if (cat === selectedCategory) option.selected = true;
                select.appendChild(option);
            });
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–π:', error);
        }
    }

    async function openAddModal() {
        currentEditId = null;
        document.getElementById('modalTitle').textContent = '–î–æ–±–∞–≤–∏—Ç—å FAQ';
        document.getElementById('faqForm').reset();
        document.getElementById('faqId').value = '';
        await loadCategories();
        initAnswerEditor();
        if (answerEditor) answerEditor.setText('');
        document.getElementById('faqModal').style.display = 'flex';
    }

    async function editFAQ(id) {
        const response = await fetchWithAuth(`${BASE_URL}/faq/${id}`);
        const faq = await response.json();

        currentEditId = id;
        document.getElementById('modalTitle').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å FAQ';
        document.getElementById('faqId').value = faq.id;
        loadCategories(faq.category);
        document.getElementById('faqQuestion').value = faq.question;
        document.getElementById('faqKeywords').value = faq.keywords.join(', ');

        initAnswerEditor();
        if (answerEditor) {
            // convertTelegramToQuillHtml —É–∂–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç BB –∫–æ–¥—ã —á–µ—Ä–µ–∑ convertBBCodeToHtml
            const quillHtml = convertTelegramToQuillHtml(faq.answer);
            answerEditor.root.innerHTML = quillHtml;
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ BB –∫–æ–¥–∞—Ö –¥–ª—è Bitrix24
            const bbcode = convertQuillToBBCode(answerEditor.root.innerHTML);
            document.getElementById('faqAnswer').value = bbcode;
        }

        document.getElementById('faqModal').style.display = 'flex';
    }

    function closeModal() {
        document.getElementById('faqModal').style.display = 'none';
        if (answerEditor) answerEditor.setText('');
    }

    function openCategoryModal() {
        document.getElementById('categoryModal').style.display = 'flex';
    }

    function closeCategoryModal() {
        document.getElementById('categoryModal').style.display = 'none';
    }

    async function saveCategory() {
        const name = document.getElementById('newCategoryName').value.trim();
        if (!name) {
            alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏');
            return;
        }

        const response = await fetchWithAuth(`${BASE_URL}/categories`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ name })
        });

        if (response.ok) {
            document.getElementById('newCategoryName').value = '';
            closeCategoryModal();
            await loadCategories(name);
            document.getElementById('faqCategory').value = name;
        } else {
            const data = await response.json();
            alert(data.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏');
        }
    }

    async function optimizeKeywords() {
        const keywordsInput = document.getElementById('faqKeywords');
        const keywords = keywordsInput.value.trim();

        if (!keywords) {
            showNotification('–í–≤–µ–¥–∏—Ç–µ –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏', 'error');
            return;
        }

        try {
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
            const originalValue = keywordsInput.value;
            keywordsInput.disabled = true;
            keywordsInput.value = '–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è...';

            showNotification('–í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤...', 'info');

            const response = await fetchWithAuth(`${BASE_URL}/api/optimize-keywords`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ keywords })
            });

            const data = await response.json();

            if (data.success) {
                keywordsInput.value = data.optimized;
                keywordsInput.disabled = false;

                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
                if (data.original_count !== data.optimized_count) {
                    const removed = data.original_count - data.optimized_count;
                    showNotification(`–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞! –ë—ã–ª–æ: ${data.original_count}, –æ—Å—Ç–∞–ª–æ—Å—å: ${data.optimized_count} (—É–¥–∞–ª–µ–Ω–æ ${removed} –¥—É–±–ª–∏–∫–∞—Ç–æ–≤)`, 'success');
                } else {
                    showNotification('–ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ —É–∂–µ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω—ã', 'success');
                }
            } else {
                keywordsInput.value = originalValue;
                keywordsInput.disabled = false;
                showNotification('–û—à–∏–±–∫–∞ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏: ' + (data.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'), 'error');
            }
        } catch (error) {
            keywordsInput.disabled = false;
            keywordsInput.value = keywords;
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤:', error);
            showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤', 'error');
        }
    }

    document.getElementById('faqForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        const data = {
            category: document.getElementById('faqCategory').value,
            question: document.getElementById('faqQuestion').value,
            answer: document.getElementById('faqAnswer').value,
            keywords: document.getElementById('faqKeywords').value
        };

        if (currentEditId) data.id = currentEditId;

        let response;
        if (currentEditId) {
            response = await fetchWithAuth(`${BASE_URL}/faq/update/${currentEditId}`, {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });
        } else {
            response = await fetchWithAuth(`${BASE_URL}/faq/add`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });
        }

        const result = await response.json();

        if (result.success) {
            showNotification(result.message, 'success');
            closeModal();
            clearSearch();
        } else {
            showNotification(result.message, 'error');
        }
    });

    async function deleteFAQ(id) {
        if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç FAQ?')) return;

        const response = await fetchWithAuth(`${BASE_URL}/faq/delete/${id}`, {
            method: 'DELETE'
        });

        const result = await response.json();

        if (result.success) {
            showNotification(result.message, 'success');
            clearSearch();
        } else {
            showNotification(result.message, 'error');
        }
    }

    async function retrainModel() {
        if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –ø–µ—Ä–µ–æ–±—É—á–∏—Ç—å –º–æ–¥–µ–ª—å? –≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –Ω–µ–∫–æ—Ç–æ—Ä–æ–µ –≤—Ä–µ–º—è.')) return;

        showNotification('–ü–µ—Ä–µ–æ–±—É—á–µ–Ω–∏–µ –º–æ–¥–µ–ª–∏...', 'info');

        const response = await fetchWithAuth(`${BASE_URL}/retrain`, {
            method: 'POST'
        });

        const result = await response.json();

        if (result.success) {
            showNotification(`${result.message} (${result.count} –∑–∞–ø–∏—Å–µ–π)`, 'success');
        } else {
            showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ–æ–±—É—á–µ–Ω–∏–∏: ' + result.message, 'error');
        }
    }

    function showNotification(message, type) {
        const notification = document.createElement('div');
        notification.className = `fixed top-5 right-5 px-6 py-3 rounded-lg shadow-lg z-[100] text-white font-medium transition-all duration-300 transform translate-x-[400px] ${
            type === 'success' ? 'bg-green-500' :
            type === 'error' ? 'bg-red-500' :
            'bg-blue-500'
        }`;

        // –î–æ–±–∞–≤–ª—è–µ–º –∏–∫–æ–Ω–∫—É –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞
        const icon = type === 'success' ? '‚úì' : type === 'error' ? '‚úï' : '‚Ñπ';
        notification.innerHTML = `<span class="text-xl mr-2">${icon}</span><span>${message}</span>`;
        notification.style.display = 'flex';
        notification.style.alignItems = 'center';

        document.body.appendChild(notification);

        // –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è
        setTimeout(() => {
            notification.style.transform = 'translateX(0)';
        }, 10);

        // –ê–Ω–∏–º–∞—Ü–∏—è –∏—Å—á–µ–∑–Ω–æ–≤–µ–Ω–∏—è –∏ —É–¥–∞–ª–µ–Ω–∏–µ
        setTimeout(() => {
            notification.style.transform = 'translateX(400px)';
            notification.style.opacity = '0';
            setTimeout(() => notification.remove(), 300);
        }, 3000);
    }

    // ========== –≠–ö–°–ü–û–†–¢ –î–õ–Ø –ê–ö–¢–£–ê–õ–ò–ó–ê–¶–ò–ò ==========

    function toggleExportMenu() {
        const menu = document.getElementById('exportMenu');
        menu.classList.toggle('hidden');
    }

    // –ó–∞–∫—Ä—ã—Ç—å –º–µ–Ω—é –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
    document.addEventListener('click', function(event) {
        const menu = document.getElementById('exportMenu');
        const button = event.target.closest('button[onclick="toggleExportMenu()"]');

        if (!button && !menu.contains(event.target)) {
            menu.classList.add('hidden');
        }
    });

    function exportForReview(format) {
        // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é –∏–∑ —Ñ–∏–ª—å—Ç—Ä–∞
        const category = document.getElementById('categoryFilter').value || 'all';

        // –§–æ—Ä–º–∏—Ä—É–µ–º URL
        const url = `${BASE_URL}/export-review?category=${encodeURIComponent(category)}&format=${format}`;

        // –°–∫—Ä—ã–≤–∞–µ–º –º–µ–Ω—é
        document.getElementById('exportMenu').classList.add('hidden');

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
        showNotification(`–ó–∞–≥—Ä—É–∑–∫–∞ ${format === 'pdf' ? 'PDF' : 'Excel'} —Ñ–∞–π–ª–∞...`, 'info');

        // –û—Ç–∫—Ä—ã–≤–∞–µ–º —Ñ–∞–π–ª –≤ –Ω–æ–≤–æ–π –≤–∫–ª–∞–¥–∫–µ (–±—Ä–∞—É–∑–µ—Ä –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫–∞—á–∞–µ—Ç)
        window.open(url, '_blank');
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    restoreSidebarState();
    setView(currentView);
    loadFAQs();
</script>
</body>
</html>
