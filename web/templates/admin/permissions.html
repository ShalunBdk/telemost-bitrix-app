<!DOCTYPE html>
<html class="light" lang="ru">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>–ü—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ - –ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</title>

    <link href="{{ url_for('static', filename='css/output.css') }}" rel="stylesheet"/>
    <script src="{{ url_for('static', filename='js/auth.js') }}"></script>

    <style>
        #toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .toast {
            min-width: 300px;
            padding: 16px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: center;
            gap: 12px;
            animation: slideIn 0.3s ease-out;
            background: white;
            border-left: 4px solid;
        }

        .toast.success {
            border-left-color: #10b981;
        }

        .toast.error {
            border-left-color: #ef4444;
        }

        .toast.warning {
            border-left-color: #f59e0b;
        }

        .toast.info {
            border-left-color: #3b82f6;
        }

        .toast-icon {
            font-size: 24px;
            flex-shrink: 0;
        }

        .toast.success .toast-icon {
            color: #10b981;
        }

        .toast.error .toast-icon {
            color: #ef4444;
        }

        .toast.warning .toast-icon {
            color: #f59e0b;
        }

        .toast.info .toast-icon {
            color: #3b82f6;
        }

        .toast-message {
            flex: 1;
            color: #1f2937;
            font-size: 14px;
            font-weight: 500;
        }

        .toast-close {
            cursor: pointer;
            color: #6b7280;
            font-size: 20px;
            line-height: 1;
            padding: 0;
            background: none;
            border: none;
            flex-shrink: 0;
        }

        .toast-close:hover {
            color: #1f2937;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(400px);
                opacity: 0;
            }
        }

        .toast.removing {
            animation: slideOut 0.3s ease-out forwards;
        }

        /* Collapsible sidebar */
        .sidebar-expanded {
            width: 16rem;
        }
        .sidebar-collapsed {
            width: 4.5rem;
        }
        .sidebar-collapsed .sidebar-text {
            display: none;
        }
        .sidebar-text {
            transition: opacity 0.2s ease-in-out;
        }
        .sidebar-collapsed .sidebar-text {
            opacity: 0;
        }
        #sidebar.sidebar-collapsed > div > div:first-child > div:first-child {
            justify-content: center !important;
        }
        #sidebar.sidebar-collapsed nav a {
            justify-content: center !important;
            padding-left: 0 !important;
            padding-right: 0 !important;
        }
    </style>
</head>
<body class="bg-background-light dark:bg-background-dark font-display min-h-screen">
    <div class="flex">
        
        <aside id="sidebar" class="sidebar-expanded bg-white dark:bg-[#182431] border-r border-gray-200 dark:border-gray-700 p-4 transition-all duration-300">
            <div class="flex flex-col h-full">
                <div class="mb-6">
                    <div class="flex items-center gap-3 mb-3">
                        <div class="bg-primary rounded-lg size-10 flex items-center justify-center flex-shrink-0">
                            <span class="material-symbols-outlined text-white">support_agent</span>
                        </div>
                        <h1 class="sidebar-text text-lg font-bold text-gray-800 dark:text-white whitespace-nowrap overflow-hidden">–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</h1>
                    </div>
                    <button onclick="toggleSidebar()" class="w-full flex items-center justify-center gap-2 py-2 rounded-lg bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors" title="–°–≤–µ—Ä–Ω—É—Ç—å/—Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—å –º–µ–Ω—é">
                        <span class="material-symbols-outlined text-gray-600 dark:text-gray-400 text-xl">menu</span>
                        <span class="sidebar-text text-sm font-medium text-gray-600 dark:text-gray-400">–°–≤–µ—Ä–Ω—É—Ç—å –º–µ–Ω—é</span>
                    </button>
                </div>

            <nav class="flex flex-col gap-2 flex-grow">
                <a class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700/50 transition-colors" href="{{ config.get('BASE_PATH', '') }}/admin/" title="–ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π">
                    <span class="material-symbols-outlined text-gray-600 dark:text-gray-400 flex-shrink-0">import_contacts</span>
                    <p class="sidebar-text text-gray-800 dark:text-gray-200 text-sm font-medium leading-normal whitespace-nowrap overflow-hidden">–ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π</p>
                </a>
                <a class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700/50 transition-colors" href="{{ config.get('BASE_PATH', '') }}/admin/logs" title="–õ–æ–≥–∏">
                    <span class="material-symbols-outlined text-gray-600 dark:text-gray-400 flex-shrink-0">receipt_long</span>
                    <p class="sidebar-text text-gray-800 dark:text-gray-200 text-sm font-medium leading-normal whitespace-nowrap overflow-hidden">–õ–æ–≥–∏</p>
                </a>
                <a class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700/50 transition-colors" href="{{ config.get('BASE_PATH', '') }}/admin/test-periods" title="–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ">
                    <span class="material-symbols-outlined text-gray-600 dark:text-gray-400 flex-shrink-0">science</span>
                    <p class="sidebar-text text-gray-800 dark:text-gray-200 text-sm font-medium leading-normal whitespace-nowrap overflow-hidden">–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</p>
                </a>
                <a class="flex items-center gap-3 px-3 py-2 rounded-lg bg-primary/20 dark:bg-primary/30 text-primary dark:text-white" href="{{ config.get('BASE_PATH', '') }}/admin/permissions" title="–ü—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞">
                    <span class="material-symbols-outlined fill flex-shrink-0">admin_panel_settings</span>
                    <p class="sidebar-text text-sm font-bold leading-normal whitespace-nowrap overflow-hidden">–ü—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞</p>
                </a>
                <a class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700/50 transition-colors" href="{{ config.get('BASE_PATH', '') }}/admin/settings" title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏">
                    <span class="material-symbols-outlined text-gray-600 dark:text-gray-400 flex-shrink-0">settings</span>
                    <p class="sidebar-text text-gray-800 dark:text-gray-200 text-sm font-medium leading-normal whitespace-nowrap overflow-hidden">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</p>
                </a>
            </nav>
        </div>
    </aside>

        
        <main class="flex-1 p-8 overflow-y-auto">
            <div class="max-w-7xl mx-auto">
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h1 class="text-3xl font-bold text-gray-900 dark:text-white">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∞–≤–∞–º–∏ –¥–æ—Å—Ç—É–ø–∞</h1>
                        <p class="text-gray-600 dark:text-gray-400 mt-2">–£–ø—Ä–∞–≤–ª—è–π—Ç–µ –¥–æ—Å—Ç—É–ø–æ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π Bitrix24 –∫ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏</p>
                    </div>
                    <button id="addUserSection" onclick="showAddUserModal()" class="flex items-center gap-2 px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors">
                        <span class="material-symbols-outlined">person_add</span>
                        <span>–î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</span>
                    </button>
                </div>

                <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ä–æ–ª—è—Ö -->
                <div class="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-4 mb-6">
                    <h3 class="font-semibold text-blue-900 dark:text-blue-200 mb-2">–†–æ–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm">
                        <div>
                            <p class="font-medium text-blue-800 dark:text-blue-300">üëë –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä (admin)</p>
                            <p class="text-blue-700 dark:text-blue-400">–ü–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø: —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ FAQ, –ª–æ–≥–∏, –Ω–∞—Å—Ç—Ä–æ–π–∫–∏, —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∞–≤–∞–º–∏</p>
                        </div>
                        <div>
                            <p class="font-medium text-blue-800 dark:text-blue-300">üëÅÔ∏è –ú–æ–¥–µ—Ä–∞—Ç–æ—Ä (observer)</p>
                            <p class="text-blue-700 dark:text-blue-400">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ FAQ –∏ –ø—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤ (–±–µ–∑ –¥–æ—Å—Ç—É–ø–∞ –∫ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º –∏ –ø—Ä–∞–≤–∞–º)</p>
                        </div>
                    </div>
                </div>

                <!-- –°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π -->
                <div class="bg-white dark:bg-gray-900 rounded-lg shadow-sm border border-gray-200 dark:border-gray-800">
                    <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-800">
                        <h2 class="text-lg font-semibold text-gray-900 dark:text-white">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å –ø—Ä–∞–≤–∞–º–∏ –¥–æ—Å—Ç—É–ø–∞</h2>
                    </div>

                    <div id="usersLoading" class="p-8 text-center">
                        <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-primary"></div>
                        <p class="mt-2 text-gray-600 dark:text-gray-400">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
                    </div>

                    <div id="usersTable" class="hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-gray-50 dark:bg-gray-800">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">ID</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">–†–æ–ª—å</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">–î–æ–±–∞–≤–ª–µ–Ω</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">–ö–µ–º</th>
                                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">–î–µ–π—Å—Ç–≤–∏—è</th>
                                    </tr>
                                </thead>
                                <tbody id="usersTableBody" class="bg-white dark:bg-gray-900 divide-y divide-gray-200 dark:divide-gray-800">
                                    <!-- –°—Ç—Ä–æ–∫–∏ –∑–∞–ø–æ–ª–Ω—è—é—Ç—Å—è —á–µ—Ä–µ–∑ JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div id="usersEmpty" class="hidden p-8 text-center">
                        <span class="material-symbols-outlined text-6xl text-gray-300 dark:text-gray-600">group_off</span>
                        <p class="mt-2 text-gray-600 dark:text-gray-400">–ù–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –ø—Ä–∞–≤–∞–º–∏</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ: –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
    <div id="addUserModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white dark:bg-gray-900 rounded-lg shadow-xl max-w-md w-full mx-4">
            <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-800">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white">–î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h3>
            </div>
            <div class="px-6 py-4">
                <div id="employeesLoading" class="text-center py-8">
                    <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-primary"></div>
                    <p class="mt-2 text-gray-600 dark:text-gray-400">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤...</p>
                </div>

                <form id="addUserForm" class="hidden">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">–°–æ—Ç—Ä—É–¥–Ω–∏–∫</label>
                        <select id="selectedEmployee" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded-lg bg-white dark:bg-gray-800 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary" required>
                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞...</option>
                        </select>
                        <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">–í—ã–±–µ—Ä–∏—Ç–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ –∏–∑ —Å–ø–∏—Å–∫–∞ Bitrix24</p>
                    </div>

                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">–†–æ–ª—å</label>
                        <select id="newUserRole" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded-lg bg-white dark:bg-gray-800 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary" required>
                            <option value="observer">–ú–æ–¥–µ—Ä–∞—Ç–æ—Ä (observer)</option>
                            <option value="admin">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä (admin)</option>
                        </select>
                    </div>

                    <div class="flex gap-3 justify-end">
                        <button type="button" onclick="hideAddUserModal()" class="px-4 py-2 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-lg transition-colors">
                            –û—Ç–º–µ–Ω–∞
                        </button>
                        <button type="submit" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors">
                            –î–æ–±–∞–≤–∏—Ç—å
                        </button>
                    </div>
                </form>

                <div id="employeesError" class="hidden text-center py-8">
                    <p class="text-red-600 dark:text-red-400" id="employeesErrorMessage"></p>
                    <button onclick="fetchEmployees()" class="mt-4 px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors">
                        –ü–æ–≤—Ç–æ—Ä–∏—Ç—å –ø–æ–ø—ã—Ç–∫—É
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toast-container"></div>

    <script>
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        const BASE_PATH = '{{ config.get("BASE_PATH", "") }}';
        let currentDomain = '{{ domain }}';
        let currentUserId = null;
        let currentUserRole = null;
        let employees = [];
        let loadingEmployees = false;

        // ========== –§–£–ù–ö–¶–ò–ò –î–õ–Ø –°–ê–ô–î–ë–ê–†–ê ==========

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–∞–π–¥–±–∞—Ä–∞ (—Å–≤–µ—Ä–Ω—É—Ç/—Ä–∞–∑–≤–µ—Ä–Ω—É—Ç)
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const isExpanded = sidebar.classList.contains('sidebar-expanded');

            if (isExpanded) {
                sidebar.classList.remove('sidebar-expanded');
                sidebar.classList.add('sidebar-collapsed');
                localStorage.setItem('sidebarState', 'collapsed');
            } else {
                sidebar.classList.remove('sidebar-collapsed');
                sidebar.classList.add('sidebar-expanded');
                localStorage.setItem('sidebarState', 'expanded');
            }
        }

        // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–∞–π–¥–±–∞—Ä–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        function restoreSidebarState() {
            const savedState = localStorage.getItem('sidebarState');
            if (savedState === 'collapsed') {
                const sidebar = document.getElementById('sidebar');
                sidebar.classList.remove('sidebar-expanded');
                sidebar.classList.add('sidebar-collapsed');
            }
        }

        // –í—ã–∑—ã–≤–∞–µ–º –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        restoreSidebarState();

        // ========== –ö–û–ù–ï–¶ –§–£–ù–ö–¶–ò–ô –î–õ–Ø –°–ê–ô–î–ë–ê–†–ê ==========

        // Toast —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;

            const icons = {
                success: 'check_circle',
                error: 'error',
                warning: 'warning',
                info: 'info'
            };

            toast.innerHTML = `
                <span class="material-symbols-outlined toast-icon">${icons[type] || icons.info}</span>
                <div class="toast-message">${message}</div>
                <button class="toast-close" onclick="this.parentElement.remove()">√ó</button>
            `;

            container.appendChild(toast);

            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–¥–∞–ª–∏—Ç—å —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
            setTimeout(() => {
                toast.classList.add('removing');
                setTimeout(() => {
                    toast.remove();
                }, 300);
            }, 5000);
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        async function loadUsers() {
            try {
                const response = await fetchWithAuth(`${BASE_PATH}/api/bitrix24/permissions/list?domain=${encodeURIComponent(currentDomain)}`);
                const data = await response.json();

                document.getElementById('usersLoading').classList.add('hidden');

                if (data.permissions && data.permissions.length > 0) {
                    document.getElementById('usersTable').classList.remove('hidden');
                    document.getElementById('usersEmpty').classList.add('hidden');

                    const tbody = document.getElementById('usersTableBody');
                    tbody.innerHTML = '';

                    data.permissions.forEach(user => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="flex items-center">
                                    <div class="flex-shrink-0 h-10 w-10 bg-primary/20 rounded-full flex items-center justify-center">
                                        <span class="material-symbols-outlined text-primary">person</span>
                                    </div>
                                    <div class="ml-4">
                                        <div class="text-sm font-medium text-gray-900 dark:text-white">${user.user_name || '–ë–µ–∑ –∏–º–µ–Ω–∏'}</div>
                                    </div>
                                </div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm text-gray-500 dark:text-gray-400">${user.user_id}</div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${user.role === 'admin' ? 'bg-purple-100 text-purple-800 dark:bg-purple-900/30 dark:text-purple-300' : 'bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-300'}">
                                    ${user.role === 'admin' ? 'üëë –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä' : 'üëÅÔ∏è –ú–æ–¥–µ—Ä–∞—Ç–æ—Ä'}
                                </span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
                                ${formatDate(user.created_at)}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
                                ID: ${user.created_by || 'N/A'}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                ${currentUserRole === 'admin' ? `<button onclick="removeUser('${user.user_id}')" class="text-red-600 hover:text-red-900 dark:text-red-400 dark:hover:text-red-300">
                                    –£–¥–∞–ª–∏—Ç—å
                                </button>` : ''}
                            </td>
                        `;
                        tbody.appendChild(row);
                    });
                } else {
                    document.getElementById('usersTable').classList.add('hidden');
                    document.getElementById('usersEmpty').classList.remove('hidden');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:', error);
                showToast('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π', 'error');
            }
        }

        // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞—Ç—ã
        function formatDate(dateStr) {
            if (!dateStr) return 'N/A';
            const date = new Date(dateStr);
            return date.toLocaleString('ru-RU', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –∏–∑ Bitrix24
        async function fetchEmployees() {
            if (loadingEmployees) return;

            try {
                loadingEmployees = true;
                document.getElementById('employeesLoading').classList.remove('hidden');
                document.getElementById('addUserForm').classList.add('hidden');
                document.getElementById('employeesError').classList.add('hidden');

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å BX24 SDK
                if (!window.parent.BX24) {
                    throw new Error('Bitrix24 SDK –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –æ—Ç–∫—Ä—ã—Ç–æ —á–µ—Ä–µ–∑ Bitrix24.');
                }

                const allEmployees = [];

                // –ü–µ—Ä–≤—ã–π –∑–∞–ø—Ä–æ—Å –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–µ—Ä–≤–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –æ–±—â–µ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞
                const firstBatch = await new Promise((resolve, reject) => {
                    window.parent.BX24.callMethod('user.get', {
                        start: 0,
                        order: { LAST_NAME: 'ASC' }
                    }, (result) => {
                        if (result.error()) {
                            reject(result.error());
                        } else {
                            resolve(result);
                        }
                    });
                });

                const firstData = firstBatch.data();
                allEmployees.push(...firstData);

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –µ—â–µ –¥–∞–Ω–Ω—ã–µ
                if (firstBatch.more && firstBatch.more()) {
                    const total = firstBatch.total ? firstBatch.total() : 1000;
                    const pagesNeeded = Math.ceil(total / 50) - 1;

                    // –°–æ–∑–¥–∞–µ–º –ø–∞–∫–µ—Ç –∑–∞–ø—Ä–æ—Å–æ–≤ –¥–ª—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏
                    const batchCalls = {};
                    for (let i = 1; i <= Math.min(pagesNeeded, 20); i++) {
                        batchCalls[`page${i}`] = ['user.get', {
                            start: i * 50,
                            order: { LAST_NAME: 'ASC' }
                        }];
                    }

                    // –í—ã–ø–æ–ª–Ω—è–µ–º –ø–∞–∫–µ—Ç–Ω—ã–π –∑–∞–ø—Ä–æ—Å
                    const batchResult = await new Promise((resolve) => {
                        window.parent.BX24.callBatch(batchCalls, (result) => {
                            resolve(result);
                        });
                    });

                    // –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ –≤—Å–µ—Ö –æ—Ç–≤–µ—Ç–æ–≤
                    for (const key in batchResult) {
                        const pageResult = batchResult[key];

                        if (pageResult && typeof pageResult.error === 'function' && pageResult.error()) {
                            continue;
                        }

                        if (pageResult && typeof pageResult.data === 'function') {
                            const data = pageResult.data();
                            if (data && Array.isArray(data) && data.length > 0) {
                                allEmployees.push(...data);
                            }
                        }
                    }
                }

                // –°–æ—Ä—Ç–∏—Ä—É–µ–º —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –ø–æ —Ñ–∞–º–∏–ª–∏–∏
                allEmployees.sort((a, b) => {
                    const lastNameA = (a.LAST_NAME || '').toLowerCase();
                    const lastNameB = (b.LAST_NAME || '').toLowerCase();
                    if (lastNameA < lastNameB) return -1;
                    if (lastNameA > lastNameB) return 1;
                    const nameA = (a.NAME || '').toLowerCase();
                    const nameB = (b.NAME || '').toLowerCase();
                    return nameA.localeCompare(nameB);
                });

                employees = allEmployees;

                // –ó–∞–ø–æ–ª–Ω—è–µ–º select
                const select = document.getElementById('selectedEmployee');
                select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞...</option>';

                employees.forEach(employee => {
                    const fullName = `${employee.LAST_NAME || ''} ${employee.NAME || ''}`.trim();
                    const option = document.createElement('option');
                    option.value = employee.ID;
                    option.textContent = fullName || `ID: ${employee.ID}`;
                    option.dataset.lastName = employee.LAST_NAME || '';
                    option.dataset.name = employee.NAME || '';
                    select.appendChild(option);
                });

                document.getElementById('employeesLoading').classList.add('hidden');
                document.getElementById('addUserForm').classList.remove('hidden');
                loadingEmployees = false;

            } catch (err) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤:', err);
                document.getElementById('employeesLoading').classList.add('hidden');
                document.getElementById('employeesError').classList.remove('hidden');
                document.getElementById('employeesErrorMessage').textContent =
                    `–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤: ${err.error_description || err.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`;
                loadingEmployees = false;
            }
        }

        // –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
        function showAddUserModal() {
            document.getElementById('addUserModal').classList.remove('hidden');

            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏
            if (employees.length === 0 && !loadingEmployees) {
                fetchEmployees();
            } else if (employees.length > 0) {
                document.getElementById('employeesLoading').classList.add('hidden');
                document.getElementById('addUserForm').classList.remove('hidden');
            }
        }

        function hideAddUserModal() {
            document.getElementById('addUserModal').classList.add('hidden');
            document.getElementById('addUserForm').reset();
        }

        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        document.getElementById('addUserForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const selectedEmployeeId = document.getElementById('selectedEmployee').value;
            const role = document.getElementById('newUserRole').value;

            if (!selectedEmployeeId) {
                showToast('–í—ã–±–µ—Ä–∏—Ç–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞', 'warning');
                return;
            }

            // –ù–∞—Ö–æ–¥–∏–º –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞
            const employee = employees.find(e => e.ID === selectedEmployeeId);
            if (!employee) {
                showToast('–°–æ—Ç—Ä—É–¥–Ω–∏–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω', 'error');
                return;
            }

            const userName = `${employee.LAST_NAME || ''} ${employee.NAME || ''}`.trim();

            try {
                const response = await fetchWithAuth(`${BASE_PATH}/api/bitrix24/permissions/add`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        domain: currentDomain,
                        user_id: employee.ID,
                        user_name: userName,
                        role: role,
                        created_by: currentUserId || '0'
                    })
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    showToast('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω!', 'success');
                    hideAddUserModal();
                    loadUsers();
                } else {
                    showToast('–û—à–∏–±–∫–∞: ' + (data.error || '–ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è'), 'error');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', error);
                showToast('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è', 'error');
            }
        });

        // –£–¥–∞–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        async function removeUser(userId) {
            if (!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –ø—Ä–∞–≤–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ID ${userId}?`)) {
                return;
            }

            try {
                const response = await fetchWithAuth(`${BASE_PATH}/api/bitrix24/permissions/remove`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        domain: currentDomain,
                        user_id: userId,
                        caller_id: currentUserId || '0'
                    })
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    showToast('–ü—Ä–∞–≤–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω—ã!', 'success');
                    loadUsers();
                } else {
                    showToast('–û—à–∏–±–∫–∞: ' + (data.error || '–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –ø—Ä–∞–≤–∞'), 'error');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', error);
                showToast('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –ø—Ä–∞–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è', 'error');
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        document.addEventListener('DOMContentLoaded', async () => {
            // –ü–æ–ª—É—á–∞–µ–º –¥–æ–º–µ–Ω –∏–∑ .env –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            if (!currentDomain) {
                currentDomain = 'your-company.bitrix24.ru'; // –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ –≤–∞—à –¥–æ–º–µ–Ω
            }

            // –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ Bitrix24 (–µ—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç–æ —á–µ—Ä–µ–∑ iframe)
            try {
                if (window.parent && window.parent.BX24) {
                    const currentUser = await new Promise((resolve, reject) => {
                        window.parent.BX24.callMethod('user.current', {}, (result) => {
                            if (result.error()) {
                                reject(result.error());
                            } else {
                                resolve(result.data());
                            }
                        });
                    });

                    if (currentUser && currentUser.ID) {
                        currentUserId = currentUser.ID;

                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–æ–ª—å —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                        const permCheck = await fetchWithAuth(`/api/bitrix24/permissions/check?domain=${encodeURIComponent(currentDomain)}&user_id=${currentUserId}`);
                        const permData = await permCheck.json();
                        if (permData.hasPermission) {
                            currentUserRole = permData.role;
                        }
                    }
                }
            } catch (err) {
                console.log('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è Bitrix24:', err);
                // –ù–µ –∫—Ä–∏—Ç–∏—á–Ω–æ, –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º —Ä–∞–±–æ—Ç—É
            }

            // –°–∫—Ä—ã–≤–∞–µ–º —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∞–≤–∞–º–∏ –¥–ª—è –Ω–µ-–∞–¥–º–∏–Ω–æ–≤
            if (currentUserRole !== 'admin') {
                const addUserSection = document.getElementById('addUserSection');
                if (addUserSection) addUserSection.style.display = 'none';
            }

            loadUsers();
        });
    </script>
</body>
</html>
