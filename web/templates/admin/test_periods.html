<!DOCTYPE html>
<html class="light" lang="ru">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>–¢–µ—Å—Ç–æ–≤—ã–µ –ø–µ—Ä–∏–æ–¥—ã - –ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</title>

    <link href="{{ url_for('static', filename='css/output.css') }}" rel="stylesheet"/>
    <script src="{{ url_for('static', filename='js/auth.js') }}"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

    <style>
        /* Collapsible sidebar */
        .sidebar-expanded {
            width: 16rem;
        }
        .sidebar-collapsed {
            width: 4.5rem;
        }
        .sidebar-collapsed .sidebar-text {
            display: none;
        }
        .sidebar-text {
            transition: opacity 0.2s ease-in-out;
        }
        .sidebar-collapsed .sidebar-text {
            opacity: 0;
        }
        #sidebar.sidebar-collapsed > div > div:first-child > div:first-child {
            justify-content: center !important;
        }
        #sidebar.sidebar-collapsed nav a {
            justify-content: center !important;
            padding-left: 0 !important;
            padding-right: 0 !important;
        }

    </style>
</head>

<body class="font-display bg-background-light dark:bg-background-dark text-[#1F2937] dark:text-gray-200">
<div class="flex min-h-screen">
    <aside id="sidebar" class="sidebar-expanded bg-white dark:bg-[#182431] border-r border-gray-200 dark:border-gray-700 p-4 transition-all duration-300">
        <div class="flex flex-col h-full">
            <div class="mb-6">
                <div class="flex items-center gap-3 mb-3">
                    <div class="bg-primary rounded-lg size-10 flex items-center justify-center flex-shrink-0">
                        <span class="material-symbols-outlined text-white">support_agent</span>
                    </div>
                    <h1 class="sidebar-text text-lg font-bold text-gray-800 dark:text-white whitespace-nowrap overflow-hidden">–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</h1>
                </div>
                <button onclick="toggleSidebar()" class="w-full flex items-center justify-center gap-2 py-2 rounded-lg bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors" title="–°–≤–µ—Ä–Ω—É—Ç—å/—Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—å –º–µ–Ω—é">
                    <span class="material-symbols-outlined text-gray-600 dark:text-gray-400 text-xl">menu</span>
                    <span class="sidebar-text text-sm font-medium text-gray-600 dark:text-gray-400">–°–≤–µ—Ä–Ω—É—Ç—å –º–µ–Ω—é</span>
                </button>
            </div>

            <nav class="flex flex-col gap-2 flex-grow">
                <a class="nav-link flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700/50 transition-colors" href="./" title="–ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π">
                    <span class="material-symbols-outlined fill flex-shrink-0">import_contacts</span>
                    <p class="sidebar-text text-sm font-medium leading-normal whitespace-nowrap overflow-hidden text-gray-800 dark:text-gray-200">–ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π</p>
                </a>
                <a class="nav-link flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700/50 transition-colors" href="./logs" title="–õ–æ–≥–∏">
                    <span class="material-symbols-outlined text-gray-600 dark:text-gray-400 flex-shrink-0">receipt_long</span>
                    <p class="sidebar-text text-gray-800 dark:text-gray-200 text-sm font-medium leading-normal whitespace-nowrap overflow-hidden">–õ–æ–≥–∏</p>
                </a>
                <a class="nav-link flex items-center gap-3 px-3 py-2 rounded-lg bg-primary/20 dark:bg-primary/30 text-primary dark:text-white" href="./test-periods" title="–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ">
                    <span class="material-symbols-outlined fill flex-shrink-0">science</span>
                    <p class="sidebar-text text-sm font-bold leading-normal whitespace-nowrap overflow-hidden">–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</p>
                </a>
                <a class="nav-link flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700/50 transition-colors" href="./permissions" title="–ü—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞">
                    <span class="material-symbols-outlined text-gray-600 dark:text-gray-400 flex-shrink-0">admin_panel_settings</span>
                    <p class="sidebar-text text-gray-800 dark:text-gray-200 text-sm font-medium leading-normal whitespace-nowrap overflow-hidden">–ü—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞</p>
                </a>
                <a class="nav-link flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700/50 transition-colors" href="./settings" title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏">
                    <span class="material-symbols-outlined text-gray-600 dark:text-gray-400 flex-shrink-0">settings</span>
                    <p class="sidebar-text text-gray-800 dark:text-gray-200 text-sm font-medium leading-normal whitespace-nowrap overflow-hidden">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</p>
                </a>
            </nav>
        </div>
    </aside>

    <main class="flex-1 p-6">
        <div class="max-w-7xl mx-auto">
            <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
            <div class="mb-6">
                <h1 class="text-3xl font-bold text-gray-800 mb-2">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤—ã–º–∏ –ø–µ—Ä–∏–æ–¥–∞–º–∏</h1>
                <p class="text-gray-600">–°–æ–∑–¥–∞–≤–∞–π—Ç–µ —Ç–µ—Å—Ç–æ–≤—ã–µ –ø–µ—Ä–∏–æ–¥—ã, —Å–æ–±–∏—Ä–∞–π—Ç–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∏ –∞–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã</p>
            </div>

            <!-- –ê–∫—Ç–∏–≤–Ω—ã–π –ø–µ—Ä–∏–æ–¥ -->
            <div id="activePeriodCard" class="mb-6 hidden">
                <div class="bg-white rounded-xl shadow-lg border-2 border-green-500 p-6">
                    <div class="flex items-start justify-between gap-6">
                        <div class="flex-1">
                            <div class="flex items-center gap-3 mb-4">
                                <div class="bg-green-500 rounded-lg p-2">
                                    <span class="material-symbols-outlined text-white text-2xl">science</span>
                                </div>
                                <div>
                                    <span class="inline-block px-3 py-1 bg-green-100 text-green-700 text-xs font-bold rounded-full mb-2">‚ö° –ê–ö–¢–ò–í–ï–ù</span>
                                    <h3 class="text-gray-800 text-lg font-bold">–¢–µ—Å—Ç–æ–≤—ã–π –ø–µ—Ä–∏–æ–¥</h3>
                                </div>
                            </div>
                            <h4 id="activePeriodName" class="text-gray-800 text-2xl font-bold mb-2"></h4>
                            <p id="activePeriodDescription" class="text-gray-600 text-base mb-3"></p>
                            <div class="flex items-center gap-2 text-gray-500 text-sm">
                                <span class="material-symbols-outlined text-lg">schedule</span>
                                <span id="activePeriodDates"></span>
                            </div>
                        </div>
                        <div class="flex flex-col gap-2">
                            <button onclick="archiveActivePeriod()" class="flex items-center gap-2 px-4 py-2 bg-green-500 text-white rounded-lg text-sm font-bold hover:bg-green-600 transition-colors shadow-sm">
                                <span class="material-symbols-outlined text-lg">archive</span>
                                <span>–ê—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞—Ç—å –ª–æ–≥–∏</span>
                            </button>
                            <button onclick="endActivePeriod()" class="flex items-center gap-2 px-4 py-2 bg-red-500 text-white rounded-lg text-sm font-bold hover:bg-red-600 transition-colors shadow-sm">
                                <span class="material-symbols-outlined text-lg">stop_circle</span>
                                <span>–ó–∞–≤–µ—Ä—à–∏—Ç—å –ø–µ—Ä–∏–æ–¥</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- –î–µ–π—Å—Ç–≤–∏—è -->
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm p-6 mb-6">
                <div class="flex flex-wrap gap-3">
                    <button onclick="showCreatePeriodModal()" class="flex items-center gap-2 px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors">
                        <span class="material-symbols-outlined text-sm">add</span>
                        <span>–°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π –ø–µ—Ä–∏–æ–¥</span>
                    </button>
                    <button onclick="clearUnarchived()" class="flex items-center gap-2 px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors">
                        <span class="material-symbols-outlined text-sm">delete_sweep</span>
                        <span>–û—á–∏—Å—Ç–∏—Ç—å –Ω–µ–∞—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ª–æ–≥–∏</span>
                    </button>
                </div>
            </div>

            <!-- –°–ø–∏—Å–æ–∫ –ø–µ—Ä–∏–æ–¥–æ–≤ -->
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                <h2 class="text-xl font-bold text-gray-800 mb-4">–ò—Å—Ç–æ—Ä–∏—è —Ç–µ—Å—Ç–æ–≤—ã—Ö –ø–µ—Ä–∏–æ–¥–æ–≤</h2>
                <div id="periodsList" class="space-y-3">
                    <div class="text-center py-8 text-gray-500">
                        <span class="material-symbols-outlined text-4xl mb-2">hourglass_empty</span>
                        <p>–ó–∞–≥—Ä—É–∑–∫–∞...</p>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–æ–∑–¥–∞–Ω–∏—è –ø–µ—Ä–∏–æ–¥–∞ -->
<div id="createPeriodModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50" onclick="hideCreatePeriodModal()">
    <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4" onclick="event.stopPropagation()">
        <div class="p-6">
            <h3 class="text-gray-800 text-xl font-bold mb-4">–°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π –ø–µ—Ä–∏–æ–¥</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                    <input type="text" id="periodName" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary" placeholder="–¢–µ—Å—Ç–æ–≤–∞—è –≥—Ä—É–ø–ø–∞ #1">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                    <textarea id="periodDescription" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary" rows="3" placeholder="–ü–µ—Ä–≤–∞—è —Ç–µ—Å—Ç–æ–≤–∞—è –≥—Ä—É–ø–ø–∞ –∏–∑ 20 —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤"></textarea>
                </div>
            </div>
            <div class="flex gap-3 mt-6">
                <button onclick="createPeriod()" class="flex-1 px-4 py-2 bg-primary text-white text-sm font-bold rounded-lg hover:bg-primary/90 transition-colors shadow-sm">
                    –°–æ–∑–¥–∞—Ç—å
                </button>
                <button onclick="hideCreatePeriodModal()" class="flex-1 px-4 py-2 bg-gray-200 text-gray-800 text-sm font-bold rounded-lg hover:bg-gray-300 transition-colors shadow-sm">
                    –û—Ç–º–µ–Ω–∞
                </button>
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–µ—Ä–∏–æ–¥–∞ -->
<div id="statsModal" class="fixed inset-0 bg-black/70 items-center justify-center" style="display: none; z-index: 9999;" onclick="if(event.target === this) hideStatsModal()">
    <div class="bg-white rounded-xl shadow-xl p-6 max-w-5xl w-full mx-8 flex flex-col" style="max-height: 85vh;">
        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
        <div class="flex items-center justify-between mb-4 pb-4 border-b border-gray-200">
            <h3 class="text-gray-800 text-xl font-bold flex items-center gap-2">
                <span class="material-symbols-outlined text-primary">analytics</span>
                –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –ø–µ—Ä–∏–æ–¥–∞
            </h3>
            <button onclick="hideStatsModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                <span class="material-symbols-outlined text-2xl">close</span>
            </button>
        </div>

        <!-- –ö–æ–Ω—Ç–µ–Ω—Ç (—Å –ø—Ä–æ–∫—Ä—É—Ç–∫–æ–π) -->
        <div class="flex-1 overflow-y-auto mb-4">
            <div id="statsContent" class="space-y-5">
                <!-- –ë—É–¥–µ—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω–æ —á–µ—Ä–µ–∑ JavaScript -->
            </div>
        </div>

        <!-- –ö–Ω–æ–ø–∫–∏ —ç–∫—Å–ø–æ—Ä—Ç–∞ -->
        <div class="flex flex-wrap gap-3 pt-4 border-t border-gray-200">
            <button onclick="exportReport('excel')" class="flex items-center gap-2 px-4 py-2 bg-green-500 text-white rounded-lg text-sm font-bold hover:bg-green-600 transition-colors shadow-sm">
                <span class="material-symbols-outlined text-lg">download</span>
                <span>Excel</span>
            </button>
            <button onclick="exportReport('json')" class="flex items-center gap-2 px-4 py-2 bg-blue-500 text-white rounded-lg text-sm font-bold hover:bg-blue-600 transition-colors shadow-sm">
                <span class="material-symbols-outlined text-lg">code</span>
                <span>JSON</span>
            </button>
            <button onclick="exportReport('csv')" class="flex items-center gap-2 px-4 py-2 bg-gray-500 text-white rounded-lg text-sm font-bold hover:bg-gray-600 transition-colors shadow-sm">
                <span class="material-symbols-outlined text-lg">table_chart</span>
                <span>CSV</span>
            </button>
            <button onclick="showFailedQueries()" class="ml-auto flex items-center gap-2 px-4 py-2 bg-red-500 text-white rounded-lg text-sm font-bold hover:bg-red-600 transition-colors shadow-sm">
                <span class="material-symbols-outlined text-lg">error</span>
                <span>–ù–µ—É–¥–∞—á–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã</span>
            </button>
        </div>
    </div>
</div>

<!-- Toast —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è -->
<div id="toast" class="fixed bottom-4 right-4 bg-gray-900 text-white px-6 py-3 rounded-lg shadow-lg hidden transform transition-all">
    <span id="toastMessage"></span>
</div>

<script>
let currentActivePeriod = null;
let currentStatsperiodId = null;

// Sidebar toggle
function toggleSidebar() {
    const sidebar = document.getElementById('sidebar');
    const isExpanded = sidebar.classList.contains('sidebar-expanded');

    if (isExpanded) {
        sidebar.classList.remove('sidebar-expanded');
        sidebar.classList.add('sidebar-collapsed');
        localStorage.setItem('sidebarState', 'collapsed');
    } else {
        sidebar.classList.remove('sidebar-collapsed');
        sidebar.classList.add('sidebar-expanded');
        localStorage.setItem('sidebarState', 'expanded');
    }
}

// –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–∞–π–¥–±–∞—Ä–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
function restoreSidebarState() {
    const savedState = localStorage.getItem('sidebarState');
    if (savedState === 'collapsed') {
        const sidebar = document.getElementById('sidebar');
        sidebar.classList.remove('sidebar-expanded');
        sidebar.classList.add('sidebar-collapsed');
    }
}

// Toast
function showToast(message, type = 'info') {
    const toast = document.getElementById('toast');
    const toastMessage = document.getElementById('toastMessage');
    toastMessage.textContent = message;

    if (type === 'error') {
        toast.classList.add('bg-red-600');
        toast.classList.remove('bg-gray-900', 'bg-green-600');
    } else if (type === 'success') {
        toast.classList.add('bg-green-600');
        toast.classList.remove('bg-gray-900', 'bg-red-600');
    } else {
        toast.classList.add('bg-gray-900');
        toast.classList.remove('bg-red-600', 'bg-green-600');
    }

    toast.classList.remove('hidden');
    setTimeout(() => toast.classList.add('hidden'), 3000);
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –ø–µ—Ä–∏–æ–¥–∞
async function loadActivePeriod() {
    try {
        const response = await fetchWithAuth('./api/test-periods/active');
        const data = await response.json();

        if (data.success && data.period) {
            currentActivePeriod = data.period;
            document.getElementById('activePeriodCard').classList.remove('hidden');
            document.getElementById('activePeriodName').textContent = data.period.name;
            document.getElementById('activePeriodDescription').textContent = data.period.description || '';
            document.getElementById('activePeriodDates').textContent = `–ù–∞—á–∞–ª–æ: ${data.period.start_date}`;
        } else {
            document.getElementById('activePeriodCard').classList.add('hidden');
            currentActivePeriod = null;
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –ø–µ—Ä–∏–æ–¥–∞:', error);
    }
}

// –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –ø–µ—Ä–∏–æ–¥–æ–≤
async function loadPeriods() {
    try {
        const response = await fetchWithAuth('./api/test-periods/list');
        const data = await response.json();

        const container = document.getElementById('periodsList');

        if (data.success && data.periods && data.periods.length > 0) {
            container.innerHTML = data.periods.map(period => `
                <div class="bg-white border border-gray-200 rounded-lg shadow-sm p-5">
                    <div class="flex items-start justify-between gap-4">
                        <div class="flex-1">
                            <div class="flex items-center gap-3 mb-3">
                                <span class="material-symbols-outlined ${period.status === 'active' ? 'text-green-500' : 'text-gray-400'}">${period.status === 'active' ? 'radio_button_checked' : 'check_circle'}</span>
                                <h4 class="text-gray-800 text-lg font-bold flex-1">${period.name}</h4>
                                ${period.status === 'active'
                                    ? '<span class="px-2 py-1 bg-green-100 text-green-700 text-xs font-bold rounded-full">–ê–∫—Ç–∏–≤–µ–Ω</span>'
                                    : '<span class="px-2 py-1 bg-gray-100 text-gray-600 text-xs font-bold rounded-full">–ó–∞–≤–µ—Ä—à—ë–Ω</span>'}
                            </div>
                            ${period.description ? `<p class="text-gray-600 text-sm mb-3">${period.description}</p>` : ''}
                            <div class="flex items-center gap-2 text-gray-500 text-sm">
                                <span class="material-symbols-outlined text-base">schedule</span>
                                <span>${period.start_date} ‚Äî ${period.end_date || '–ê–∫—Ç–∏–≤–µ–Ω'}</span>
                            </div>
                        </div>
                        <div>
                            <button onclick="viewStatistics(${period.id})" class="flex items-center gap-2 px-4 py-2 bg-primary text-white rounded-lg text-sm font-bold hover:bg-primary/90 transition-colors shadow-sm">
                                <span class="material-symbols-outlined text-lg">analytics</span>
                                <span>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</span>
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        } else {
            container.innerHTML = `
                <div class="text-center py-8 text-gray-500">
                    <span class="material-symbols-outlined text-4xl mb-2">inbox</span>
                    <p>–ù–µ—Ç —Ç–µ—Å—Ç–æ–≤—ã—Ö –ø–µ—Ä–∏–æ–¥–æ–≤</p>
                </div>
            `;
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–µ—Ä–∏–æ–¥–æ–≤:', error);
        showToast('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–µ—Ä–∏–æ–¥–æ–≤', 'error');
    }
}

// –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–æ–∑–¥–∞–Ω–∏—è
function showCreatePeriodModal() {
    if (currentActivePeriod) {
        showToast('–°–Ω–∞—á–∞–ª–∞ –∑–∞–≤–µ—Ä—à–∏—Ç–µ –∞–∫—Ç–∏–≤–Ω—ã–π –ø–µ—Ä–∏–æ–¥', 'error');
        return;
    }
    document.getElementById('createPeriodModal').classList.remove('hidden');
    document.getElementById('createPeriodModal').classList.add('flex');
}

function hideCreatePeriodModal() {
    document.getElementById('createPeriodModal').classList.add('hidden');
    document.getElementById('createPeriodModal').classList.remove('flex');
    document.getElementById('periodName').value = '';
    document.getElementById('periodDescription').value = '';
}

// –°–æ–∑–¥–∞–Ω–∏–µ –ø–µ—Ä–∏–æ–¥–∞
async function createPeriod() {
    const name = document.getElementById('periodName').value.trim();
    const description = document.getElementById('periodDescription').value.trim();

    if (!name) {
        showToast('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø–µ—Ä–∏–æ–¥–∞', 'error');
        return;
    }

    try {
        const response = await fetchWithAuth('./api/test-periods/create', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name, description })
        });

        const data = await response.json();

        if (data.success) {
            showToast(data.message, 'success');
            hideCreatePeriodModal();
            loadActivePeriod();
            loadPeriods();
        } else {
            showToast(data.message, 'error');
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–µ—Ä–∏–æ–¥–∞:', error);
        showToast('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–µ—Ä–∏–æ–¥–∞', 'error');
    }
}

// –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –ø–µ—Ä–∏–æ–¥–∞
async function endActivePeriod() {
    if (!currentActivePeriod) return;

    if (!confirm(`–ó–∞–≤–µ—Ä—à–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π –ø–µ—Ä–∏–æ–¥ "${currentActivePeriod.name}"?`)) return;

    try {
        const response = await fetchWithAuth(`./api/test-periods/${currentActivePeriod.id}/end`, {
            method: 'POST'
        });

        const data = await response.json();

        if (data.success) {
            showToast(data.message, 'success');
            loadActivePeriod();
            loadPeriods();
        } else {
            showToast(data.message, 'error');
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ø–µ—Ä–∏–æ–¥–∞:', error);
        showToast('–û—à–∏–±–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ø–µ—Ä–∏–æ–¥–∞', 'error');
    }
}

// –ê—Ä—Ö–∏–≤–∞—Ü–∏—è –ª–æ–≥–æ–≤
async function archiveActivePeriod() {
    if (!currentActivePeriod) return;

    if (!confirm('–ê—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ —Ç–µ–∫—É—â–∏–µ –ª–æ–≥–∏ –≤ —ç—Ç–æ—Ç –ø–µ—Ä–∏–æ–¥?')) return;

    try {
        const response = await fetchWithAuth(`./api/test-periods/${currentActivePeriod.id}/archive`, {
            method: 'POST'
        });

        const data = await response.json();

        if (data.success) {
            showToast(data.message, 'success');
        } else {
            showToast(data.message, 'error');
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∞—Ä—Ö–∏–≤–∞—Ü–∏–∏ –ª–æ–≥–æ–≤:', error);
        showToast('–û—à–∏–±–∫–∞ –∞—Ä—Ö–∏–≤–∞—Ü–∏–∏ –ª–æ–≥–æ–≤', 'error');
    }
}

// –û—á–∏—Å—Ç–∫–∞ –Ω–µ–∞—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ª–æ–≥–æ–≤
async function clearUnarchived() {
    if (!confirm('–í–ù–ò–ú–ê–ù–ò–ï! –≠—Ç–æ —É–¥–∞–ª–∏—Ç –≤—Å–µ –ª–æ–≥–∏, –Ω–µ –ø—Ä–∏–≤—è–∑–∞–Ω–Ω—ã–µ –∫ —Ç–µ—Å—Ç–æ–≤—ã–º –ø–µ—Ä–∏–æ–¥–∞–º. –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?')) return;

    try {
        const response = await fetchWithAuth('./api/test-periods/clear-unarchived', {
            method: 'POST'
        });

        const data = await response.json();

        if (data.success) {
            showToast(data.message, 'success');
        } else {
            showToast(data.message, 'error');
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏ –ª–æ–≥–æ–≤:', error);
        showToast('–û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏ –ª–æ–≥–æ–≤', 'error');
    }
}

// –ü—Ä–æ—Å–º–æ—Ç—Ä —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
async function viewStatistics(periodId) {
    currentStatsperiodId = periodId;

    try {
        const response = await fetchWithAuth(`./api/test-periods/${periodId}/statistics`);
        const data = await response.json();

        if (data.success) {
            displayStatistics(data.statistics);
            document.getElementById('statsModal').style.display = 'flex';
        } else {
            showToast(data.message, 'error');
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:', error);
        showToast('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏', 'error');
    }
}

function hideStatsModal() {
    document.getElementById('statsModal').style.display = 'none';
    currentStatsperiodId = null;
}

// –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
function displayStatistics(stats) {
    const content = document.getElementById('statsContent');

    // –ö–ª—é—á–µ–≤—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏
    const levelsHtml = Object.entries(stats.search_levels || {}).map(([level, data]) => {
        const icons = {
            exact: 'üéØ',
            keyword: 'üîë',
            semantic: 'üß†',
            disambiguation_shown: 'üîÄ',
            disambiguation: '‚úÖ',
            direct: 'üìÑ',
            none: '‚ùå'
        };
        const names = {
            exact: '–¢–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ',
            keyword: '–ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞',
            semantic: '–°–µ–º–∞–Ω—Ç–∏–∫–∞',
            disambiguation_shown: '–ü–æ–∫–∞–∑ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤',
            disambiguation: '–í—ã–±–æ—Ä –≤–∞—Ä–∏–∞–Ω—Ç–∞',
            direct: '–ü—Ä—è–º–æ–π –≤—ã–∑–æ–≤',
            none: '–ù–µ—Ç –æ—Ç–≤–µ—Ç–∞'
        };
        return `
            <div class="bg-gray-50 rounded-lg p-3 border border-gray-200">
                <div class="text-2xl mb-1">${icons[level] || ''}</div>
                <div class="text-sm text-gray-600 mb-1">${names[level] || level}</div>
                <div class="text-xl font-bold text-gray-900">${data.count}</div>
                <div class="text-xs text-gray-500">${data.avg_confidence}% —Å—Ä. —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å</div>
            </div>
        `;
    }).join('');

    content.innerHTML = `
        <!-- –û–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div class="bg-blue-50 rounded-lg p-4 border border-blue-200">
                <div class="text-sm text-blue-700 mb-1">–í—Å–µ–≥–æ –∑–∞–ø—Ä–æ—Å–æ–≤</div>
                <div class="text-3xl font-bold text-blue-900">${stats.total_queries}</div>
            </div>
            <div class="bg-green-50 rounded-lg p-4 border border-green-200">
                <div class="text-sm text-green-700 mb-1">–£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>
                <div class="text-3xl font-bold text-green-900">${stats.unique_users}</div>
            </div>
            <div class="bg-purple-50 rounded-lg p-4 border border-purple-200">
                <div class="text-sm text-purple-700 mb-1">% –ø–æ–ª–µ–∑–Ω–æ—Å—Ç–∏</div>
                <div class="text-3xl font-bold text-purple-900">${stats.helpful_percentage}%</div>
            </div>
            <div class="bg-red-50 rounded-lg p-4 border border-red-200">
                <div class="text-sm text-red-700 mb-1">–ë–µ–∑ –æ—Ç–≤–µ—Ç–∞</div>
                <div class="text-3xl font-bold text-red-900">${stats.no_answer_count}</div>
            </div>
        </div>

        <!-- –£—Ä–æ–≤–Ω–∏ –ø–æ–∏—Å–∫–∞ -->
        <div>
            <h4 class="text-gray-800 text-lg font-bold mb-3">–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ —É—Ä–æ–≤–Ω—è–º –ø–æ–∏—Å–∫–∞</h4>
            <div class="grid grid-cols-2 md:grid-cols-5 gap-3">
                ${levelsHtml}
            </div>
        </div>

        <!-- –ü–æ–ø—É–ª—è—Ä–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã -->
        ${stats.top_queries && stats.top_queries.length > 0 ? `
        <div>
            <h4 class="text-gray-800 text-lg font-bold mb-3">–ü–æ–ø—É–ª—è—Ä–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã</h4>
            <div class="bg-gray-50 rounded-lg p-4 border border-gray-200">
                <ol class="space-y-2">
                    ${stats.top_queries.slice(0, 10).map(q => `
                        <li class="flex justify-between items-center">
                            <span class="text-gray-800">${q.query}</span>
                            <span class="px-2 py-1 bg-gray-200 text-gray-800 rounded text-sm font-medium">${q.count}</span>
                        </li>
                    `).join('')}
                </ol>
            </div>
        </div>
        ` : ''}

        <!-- –õ—É—á—à–∏–µ FAQ -->
        ${stats.top_helpful_faqs && stats.top_helpful_faqs.length > 0 ? `
        <div>
            <h4 class="text-gray-800 text-lg font-bold mb-3">üëç FAQ —Å –ª—É—á—à–∏–º–∏ –æ—Ü–µ–Ω–∫–∞–º–∏</h4>
            <div class="bg-green-50 rounded-lg p-4 border border-green-200">
                <div class="space-y-2">
                    ${stats.top_helpful_faqs.map(faq => `
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <div class="font-medium text-gray-800">${faq.question}</div>
                                <div class="text-sm text-gray-600">${faq.category}</div>
                            </div>
                            <span class="px-2 py-1 bg-green-500 text-white rounded text-sm font-bold ml-3">+${faq.helpful_count}</span>
                        </div>
                    `).join('')}
                </div>
            </div>
        </div>
        ` : ''}

        <!-- FAQ —Ç—Ä–µ–±—É—é—â–∏–µ —É–ª—É—á—à–µ–Ω–∏—è -->
        ${stats.need_improvement_faqs && stats.need_improvement_faqs.length > 0 ? `
        <div>
            <h4 class="text-gray-800 text-lg font-bold mb-3">‚ö†Ô∏è FAQ —Ç—Ä–µ–±—É—é—â–∏–µ —É–ª—É—á—à–µ–Ω–∏—è</h4>
            <div class="bg-red-50 rounded-lg p-4 border border-red-200">
                <div class="space-y-2">
                    ${stats.need_improvement_faqs.map(faq => `
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <div class="font-medium text-gray-800">${faq.question}</div>
                                <div class="text-sm text-gray-600">${faq.category}</div>
                            </div>
                            <span class="px-2 py-1 bg-red-500 text-white rounded text-sm font-bold ml-3">-${faq.not_helpful_count}</span>
                        </div>
                    `).join('')}
                </div>
            </div>
        </div>
        ` : ''}
    `;
}

// –≠–∫—Å–ø–æ—Ä—Ç –æ—Ç—á–µ—Ç–∞
async function exportReport(format) {
    if (!currentStatsperiodId) return;

    try {
        showToast(`–°–∫–∞—á–∏–≤–∞–Ω–∏–µ ${format.toUpperCase()} –æ—Ç—á–µ—Ç–∞...`, 'success');

        const url = `./api/test-periods/${currentStatsperiodId}/export?format=${format}`;
        const response = await fetchWithAuth(url);

        if (!response.ok) {
            throw new Error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏–∏ –æ—Ç—á–µ—Ç–∞');
        }

        // –ü–æ–ª—É—á–∞–µ–º blob –¥–∞–Ω–Ω—ã—Ö
        const blob = await response.blob();

        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∏–º—è —Ñ–∞–π–ª–∞ –∏ —Ç–∏–ø
        let filename = `test_period_${currentStatsperiodId}_report`;
        let mimeType;

        if (format === 'excel') {
            filename += '.xlsx';
            mimeType = 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet';
        } else if (format === 'json') {
            filename += '.json';
            mimeType = 'application/json';
        } else if (format === 'csv') {
            filename += '.csv';
            mimeType = 'text/csv';
        }

        // –°–æ–∑–¥–∞–µ–º —Å—Å—ã–ª–∫—É –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
        const downloadUrl = window.URL.createObjectURL(new Blob([blob], { type: mimeType }));
        const link = document.createElement('a');
        link.href = downloadUrl;
        link.download = filename;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        window.URL.revokeObjectURL(downloadUrl);

        showToast(`${format.toUpperCase()} –æ—Ç—á–µ—Ç —Å–∫–∞—á–∞–Ω —É—Å–ø–µ—à–Ω–æ`, 'success');
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞:', error);
        showToast('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏–∏ –æ—Ç—á–µ—Ç–∞', 'error');
    }
}

// –ü—Ä–æ—Å–º–æ—Ç—Ä –Ω–µ—É–¥–∞—á–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
async function showFailedQueries() {
    if (!currentStatsperiodId) return;

    try {
        const response = await fetchWithAuth(`./api/test-periods/${currentStatsperiodId}/failed-queries`);
        const data = await response.json();

        if (data.success) {
            const content = document.getElementById('statsContent');
            content.innerHTML = `
                <div class="flex items-center justify-between mb-4">
                    <h4 class="text-lg font-bold text-gray-800">–ù–µ—É–¥–∞—á–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã (–¥–ª—è —Ä–∞–±–æ—Ç—ã –Ω–∞–¥ –æ—à–∏–±–∫–∞–º–∏)</h4>
                    <button onclick="viewStatistics(${currentStatsperiodId})" class="text-primary hover:underline">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–µ</button>
                </div>
                <div class="bg-red-50 rounded-lg p-4 border border-red-200 max-h-96 overflow-y-auto">
                    ${data.failed_queries.length > 0 ? `
                        <div class="space-y-3">
                            ${data.failed_queries.map(q => `
                                <div class="bg-white rounded p-3 border-l-4 ${q.rating === 'not_helpful' ? 'border-red-500' : 'border-gray-400'} shadow-sm">
                                    <div class="font-medium text-gray-800 mb-1">${q.query_text}</div>
                                    <div class="text-sm text-gray-600">
                                        <span class="mr-3">üë§ ${q.username || '–ê–Ω–æ–Ω–∏–º'}</span>
                                        <span class="mr-3">üì± ${q.platform}</span>
                                        <span class="mr-3">üéØ ${q.search_level || 'N/A'}</span>
                                        ${q.similarity_score ? `<span class="mr-3">üìä ${q.similarity_score.toFixed(1)}%</span>` : ''}
                                        ${q.rating ? `<span>‚≠ê ${q.rating === 'not_helpful' ? 'üëé –ù–µ –ø–æ–º–æ–≥–ª–æ' : 'üëç –ü–æ–º–æ–≥–ª–æ'}</span>` : ''}
                                    </div>
                                    ${q.faq_question ? `<div class="text-xs text-gray-500 mt-1">–ü–æ–∫–∞–∑–∞–Ω FAQ: ${q.faq_question}</div>` : ''}
                                </div>
                            `).join('')}
                        </div>
                    ` : '<p class="text-center text-gray-500 py-4">–ù–µ—É–¥–∞—á–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</p>'}
                </div>
            `;
        } else {
            showToast(data.message, 'error');
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–µ—É–¥–∞—á–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤:', error);
        showToast('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–µ—É–¥–∞—á–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤', 'error');
    }
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
document.addEventListener('DOMContentLoaded', () => {
    restoreSidebarState();
    loadActivePeriod();
    loadPeriods();
});
</script>
</body>
</html>
