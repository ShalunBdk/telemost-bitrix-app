<!DOCTYPE html>
<html class="light" lang="ru">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –±–æ—Ç–∞ - –ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</title>

    <link href="{{ url_for('static', filename='css/output.css') }}" rel="stylesheet"/>
    <script src="{{ url_for('static', filename='js/auth.js') }}"></script>
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

    <style>
        .wysiwyg-editor {
            background: white;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            height: auto !important;
        }
        .wysiwyg-editor .ql-toolbar {
            border: none;
            border-bottom: 2px solid #dee2e6;
            background: #f8f9fa;
            padding: 8px;
        }
        .wysiwyg-editor .ql-container {
            border: none;
            font-size: 16px;
            font-family: inherit;
            height: 150px;
        }
        .wysiwyg-editor .ql-editor {
            height: 150px;
            padding: 12px;
            line-height: 1.6;
            overflow-y: auto;
        }

        /* –î–ª—è –¥–ª–∏–Ω–Ω–æ–≥–æ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è */
        #start_message_editor .ql-container,
        #start_message_editor .ql-editor {
            height: 180px;
        }

        /* –î–ª—è –∫–æ—Ä–æ—Ç–∫–∏—Ö –æ—Ç–≤–µ—Ç–æ–≤ –Ω–∞ –æ–±—Ä–∞—Ç–Ω—É—é —Å–≤—è–∑—å */
        #feedback_response_yes_editor .ql-container,
        #feedback_response_no_editor .ql-container,
        #feedback_response_yes_editor .ql-editor,
        #feedback_response_no_editor .ql-editor {
            height: 100px;
        }

        .wysiwyg-editor .ql-editor.ql-blank::before {
            color: #adb5bd;
            font-style: normal;
        }
        .wysiwyg-editor:focus-within {
            border-color: #3498db;
        }

        /* –°–∫—Ä—ã–≤–∞–µ–º textarea –¥–ª—è WYSIWYG —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ */
        .wysiwyg-source {
            display: none !important;
        }

        /* Telegram Preview */
        .telegram-message {
            background: #2481cc;
            color: white;
            padding: 12px 16px;
            border-radius: 12px 12px 12px 4px;
            max-width: 85%;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            font-size: 15px;
            line-height: 1.5;
            word-wrap: break-word;
        }
        .telegram-message strong { font-weight: bold; }
        .telegram-message em { font-style: italic; }
        .telegram-message code {
            background: rgba(255, 255, 255, 0.2);
            padding: 2px 5px;
            border-radius: 3px;
            font-family: monospace;
        }

        .telegram-button {
            background: white;
            color: #2481cc;
            padding: 10px 16px;
            border-radius: 8px;
            display: inline-block;
            font-weight: 500;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            text-align: center;
            min-width: 120px;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è —Å–≤–æ—Ä–∞—á–∏–≤–∞—é—â–µ–≥–æ—Å—è —Å–∞–π–¥–±–∞—Ä–∞ */
        .sidebar-expanded {
            width: 16rem; /* 256px / w-64 */
        }

        .sidebar-collapsed {
            width: 4.5rem; /* 72px - –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª—è –∏–∫–æ–Ω–æ–∫ —Å padding */
        }

        .sidebar-collapsed .sidebar-text {
            display: none;
        }

        /* –ü–ª–∞–≤–Ω—ã–π –ø–µ—Ä–µ—Ö–æ–¥ –¥–ª—è —Ç–µ–∫—Å—Ç–∞ */
        .sidebar-text {
            transition: opacity 0.2s ease-in-out;
        }

        .sidebar-collapsed .sidebar-text {
            opacity: 0;
        }

        /* –¶–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ header —Å–∞–π–¥–±–∞—Ä–∞ –∫–æ–≥–¥–∞ –æ–Ω —Å–≤—ë—Ä–Ω—É—Ç */
        #sidebar.sidebar-collapsed > div > div:first-child > div:first-child {
            justify-content: center !important;
        }

        /* –¶–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –∫–æ–≥–¥–∞ —Å–∞–π–¥–±–∞—Ä —Å–≤—ë—Ä–Ω—É—Ç */
        #sidebar.sidebar-collapsed nav a {
            justify-content: center !important;
            padding-left: 0 !important;
            padding-right: 0 !important;
        }
    </style>
</head>

<body class="font-display bg-background-light dark:bg-background-dark text-[#1F2937] dark:text-gray-200">
<div class="flex min-h-screen">
    
    <aside id="sidebar" class="sidebar-expanded bg-white dark:bg-[#182431] border-r border-gray-200 dark:border-gray-700 p-4 transition-all duration-300">
        <div class="flex flex-col h-full">
            <div class="mb-6">
                <div class="flex items-center gap-3 mb-3">
                    <div class="bg-primary rounded-lg size-10 flex items-center justify-center flex-shrink-0">
                        <span class="material-symbols-outlined text-white">support_agent</span>
                    </div>
                    <h1 class="sidebar-text text-lg font-bold text-gray-800 dark:text-white whitespace-nowrap overflow-hidden">–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</h1>
                </div>
                <button onclick="toggleSidebar()" class="w-full flex items-center justify-center gap-2 py-2 rounded-lg bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors" title="–°–≤–µ—Ä–Ω—É—Ç—å/—Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—å –º–µ–Ω—é">
                    <span class="material-symbols-outlined text-gray-600 dark:text-gray-400 text-xl">menu</span>
                    <span class="sidebar-text text-sm font-medium text-gray-600 dark:text-gray-400">–°–≤–µ—Ä–Ω—É—Ç—å –º–µ–Ω—é</span>
                </button>
            </div>

            <nav class="flex flex-col gap-2 flex-grow">
                <a class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700/50 transition-colors" href="{{ config.get('BASE_PATH', '') }}/admin/" title="–ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π">
                    <span class="material-symbols-outlined text-gray-600 dark:text-gray-400 flex-shrink-0">import_contacts</span>
                    <p class="sidebar-text text-gray-800 dark:text-gray-200 text-sm font-medium leading-normal whitespace-nowrap overflow-hidden">–ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π</p>
                </a>
                <a class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700/50 transition-colors" href="{{ config.get('BASE_PATH', '') }}/admin/logs" title="–õ–æ–≥–∏">
                    <span class="material-symbols-outlined text-gray-600 dark:text-gray-400 flex-shrink-0">receipt_long</span>
                    <p class="sidebar-text text-gray-800 dark:text-gray-200 text-sm font-medium leading-normal whitespace-nowrap overflow-hidden">–õ–æ–≥–∏</p>
                </a>
                <a class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700/50 transition-colors" href="{{ config.get('BASE_PATH', '') }}/admin/test-periods" title="–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ">
                    <span class="material-symbols-outlined text-gray-600 dark:text-gray-400 flex-shrink-0">science</span>
                    <p class="sidebar-text text-gray-800 dark:text-gray-200 text-sm font-medium leading-normal whitespace-nowrap overflow-hidden">–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</p>
                </a>
                <a class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700/50 transition-colors" href="{{ config.get('BASE_PATH', '') }}/admin/permissions" title="–ü—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞">
                    <span class="material-symbols-outlined text-gray-600 dark:text-gray-400 flex-shrink-0">admin_panel_settings</span>
                    <p class="sidebar-text text-gray-800 dark:text-gray-200 text-sm font-medium leading-normal whitespace-nowrap overflow-hidden">–ü—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞</p>
                </a>
                <a class="flex items-center gap-3 px-3 py-2 rounded-lg bg-primary/20 dark:bg-primary/30 text-primary dark:text-white" href="{{ config.get('BASE_PATH', '') }}/admin/settings" title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏">
                    <span class="material-symbols-outlined fill flex-shrink-0">settings</span>
                    <p class="sidebar-text text-sm font-bold leading-normal whitespace-nowrap overflow-hidden">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</p>
                </a>
            </nav>
        </div>
    </aside>

    
    <main class="flex-1 p-6 lg:p-10">
        <div class="max-w-5xl mx-auto">
            
            <div class="flex flex-wrap justify-between items-center gap-4 mb-8">
                <div class="flex flex-col gap-1">
                    <h1 class="text-gray-800 dark:text-white text-3xl font-bold leading-tight">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –±–æ—Ç–∞</h1>
                    <p class="text-gray-500 dark:text-gray-400 text-base font-normal leading-normal">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞–º–∏ –∏ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏ Telegram-–±–æ—Ç–∞.</p>
                </div>
            </div>

            
            <div id="loadingIndicator" class="text-center py-12 text-primary">
                <span class="material-symbols-outlined text-4xl animate-spin inline-block mb-2">refresh</span>
                <p>–ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫...</p>
            </div>

            
            <form id="settingsForm" class="space-y-6" style="display: none;">
                
                <div class="bg-white dark:bg-[#182431] rounded-xl shadow-md border border-gray-200 dark:border-gray-700 p-6">
                    <h3 class="text-gray-800 dark:text-white text-xl font-bold mb-2 flex items-center gap-2">
                        <span class="material-symbols-outlined text-primary">waving_hand</span>
                        –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (/start)
                    </h3>
                    <p class="text-gray-500 dark:text-gray-400 text-sm mb-4">
                        –≠—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤–∏–¥—è—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –Ω–∞ –∫–æ–º–∞–Ω–¥—É /start –∏–ª–∏ /help. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø–∞–Ω–µ–ª—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–µ–∫—Å—Ç–∞.
                    </p>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 items-start">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">–¢–µ–∫—Å—Ç –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è:</label>
                            <textarea id="start_message" class="wysiwyg-source" required></textarea>
                            <div id="start_message_editor" class="wysiwyg-editor"></div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –≤ Telegram:</label>
                            <div class="bg-gray-100 dark:bg-gray-700/50 rounded-lg p-4 min-h-[180px]">
                                <div class="telegram-message">
                                    <div id="start_message_preview"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- –ö–Ω–æ–ø–∫–∞ "–ü–æ–ª–µ–∑–Ω–æ" -->
                <div class="bg-white dark:bg-[#182431] rounded-xl shadow-md border border-gray-200 dark:border-gray-700 p-6">
                    <h3 class="text-gray-800 dark:text-white text-xl font-bold mb-2 flex items-center gap-2">
                        <span class="material-symbols-outlined text-green-500 fill">thumb_up</span>
                        –ö–Ω–æ–ø–∫–∞ –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏ "–ü–æ–ª–µ–∑–Ω–æ"
                    </h3>
                    <p class="text-gray-500 dark:text-gray-400 text-sm mb-4">
                        –¢–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏, –∫–æ—Ç–æ—Ä–∞—è –ø–æ—è–≤–ª—è–µ—Ç—Å—è –ø–æ–¥ –æ—Ç–≤–µ—Ç–∞–º–∏ –±–æ—Ç–∞.
                    </p>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 items-start">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">–¢–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏:</label>
                            <input type="text" id="feedback_button_yes" required class="form-input w-full rounded-lg border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –≤ Telegram:</label>
                            <div class="bg-gray-100 dark:bg-gray-700/50 rounded-lg p-4">
                                <div class="telegram-button" id="feedback_button_yes_preview"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- –ö–Ω–æ–ø–∫–∞ "–ù–µ –ø–æ–º–æ–≥–ª–æ" -->
                <div class="bg-white dark:bg-[#182431] rounded-xl shadow-md border border-gray-200 dark:border-gray-700 p-6">
                    <h3 class="text-gray-800 dark:text-white text-xl font-bold mb-2 flex items-center gap-2">
                        <span class="material-symbols-outlined text-red-500 fill">thumb_down</span>
                        –ö–Ω–æ–ø–∫–∞ –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏ "–ù–µ –ø–æ–º–æ–≥–ª–æ"
                    </h3>
                    <p class="text-gray-500 dark:text-gray-400 text-sm mb-4">
                        –¢–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏ –¥–ª—è –Ω–µ–≥–∞—Ç–∏–≤–Ω–æ–≥–æ –æ—Ç–∑—ã–≤–∞.
                    </p>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 items-start">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">–¢–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏:</label>
                            <input type="text" id="feedback_button_no" required class="form-input w-full rounded-lg border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –≤ Telegram:</label>
                            <div class="bg-gray-100 dark:bg-gray-700/50 rounded-lg p-4">
                                <div class="telegram-button" id="feedback_button_no_preview"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- –û—Ç–≤–µ—Ç –Ω–∞ "–ü–æ–ª–µ–∑–Ω–æ" -->
                <div class="bg-white dark:bg-[#182431] rounded-xl shadow-md border border-gray-200 dark:border-gray-700 p-6">
                    <h3 class="text-gray-800 dark:text-white text-xl font-bold mb-2 flex items-center gap-2">
                        <span class="material-symbols-outlined text-green-500 fill">check_circle</span>
                        –û—Ç–≤–µ—Ç –Ω–∞ –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–π –æ—Ç–∑—ã–≤
                    </h3>
                    <p class="text-gray-500 dark:text-gray-400 text-sm mb-4">
                        –°–æ–æ–±—â–µ–Ω–∏–µ, –∫–æ—Ç–æ—Ä–æ–µ –≤–∏–¥–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ—Å–ª–µ –Ω–∞–∂–∞—Ç–∏—è –Ω–∞ –∫–Ω–æ–ø–∫—É "–ü–æ–ª–µ–∑–Ω–æ".
                    </p>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 items-start">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">–¢–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞:</label>
                            <textarea id="feedback_response_yes" class="wysiwyg-source" required></textarea>
                            <div id="feedback_response_yes_editor" class="wysiwyg-editor"></div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –≤ Telegram:</label>
                            <div class="bg-gray-100 dark:bg-gray-700/50 rounded-lg p-4">
                                <div class="telegram-message">
                                    <div id="feedback_response_yes_preview"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- –û—Ç–≤–µ—Ç –Ω–∞ "–ù–µ –ø–æ–º–æ–≥–ª–æ" -->
                <div class="bg-white dark:bg-[#182431] rounded-xl shadow-md border border-gray-200 dark:border-gray-700 p-6">
                    <h3 class="text-gray-800 dark:text-white text-xl font-bold mb-2 flex items-center gap-2">
                        <span class="material-symbols-outlined text-red-500 fill">cancel</span>
                        –û—Ç–≤–µ—Ç –Ω–∞ –Ω–µ–≥–∞—Ç–∏–≤–Ω—ã–π –æ—Ç–∑—ã–≤
                    </h3>
                    <p class="text-gray-500 dark:text-gray-400 text-sm mb-4">
                        –°–æ–æ–±—â–µ–Ω–∏–µ, –∫–æ—Ç–æ—Ä–æ–µ –≤–∏–¥–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ—Å–ª–µ –Ω–∞–∂–∞—Ç–∏—è –Ω–∞ –∫–Ω–æ–ø–∫—É "–ù–µ –ø–æ–º–æ–≥–ª–æ". –ó–¥–µ—Å—å –º–æ–∂–Ω–æ —É–∫–∞–∑–∞—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç—ã –¥–ª—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –ø–æ–º–æ—â–∏.
                    </p>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 items-start">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">–¢–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞:</label>
                            <textarea id="feedback_response_no" class="wysiwyg-source" required></textarea>
                            <div id="feedback_response_no_editor" class="wysiwyg-editor"></div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –≤ Telegram:</label>
                            <div class="bg-gray-100 dark:bg-gray-700/50 rounded-lg p-4">
                                <div class="telegram-message">
                                    <div id="feedback_response_no_preview"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- –ö–∞—Å–∫–∞–¥–Ω—ã–π –ø–æ–∏—Å–∫ -->
                <div class="space-y-3 mt-6">
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white flex items-center gap-2">
                        <span class="material-symbols-outlined text-primary">layers</span>
                        –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–∞—Å–∫–∞–¥–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞
                    </h3>
                    <p class="text-gray-500 dark:text-gray-400 text-sm mb-4">
                        –ü–æ—Ä–æ–≥–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —É—Ä–æ–≤–Ω–µ–π –ø–æ–∏—Å–∫–∞. –ö–∞—Å–∫–∞–¥–Ω—ã–π –ø–æ–∏—Å–∫ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç 3 —É—Ä–æ–≤–Ω—è: —Ç–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ ‚Üí –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ ‚Üí —Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–π AI-–ø–æ–∏—Å–∫.
                    </p>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Exact Match Threshold -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                <span class="flex items-center gap-1">
                                    <span class="material-symbols-outlined text-sm">target</span>
                                    –ü–æ—Ä–æ–≥ —Ç–æ—á–Ω–æ–≥–æ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è (%)
                                </span>
                            </label>
                            <input type="number" id="exact_match_threshold" min="90" max="100" step="1" value="95" class="form-input w-full rounded-lg border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white">
                            <p class="text-xs text-gray-500 mt-1">–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è: 95. –£—Ä–æ–≤–µ–Ω—å 1: –¢–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ –≤–æ–ø—Ä–æ—Å–∞.</p>
                        </div>

                        <!-- Keyword Match Threshold -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                <span class="flex items-center gap-1">
                                    <span class="material-symbols-outlined text-sm">key</span>
                                    –ü–æ—Ä–æ–≥ –ø–æ–∏—Å–∫–∞ –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º (%)
                                </span>
                            </label>
                            <input type="number" id="keyword_match_threshold" min="60" max="95" step="1" value="65" class="form-input w-full rounded-lg border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white">
                            <p class="text-xs text-gray-500 mt-1">–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è: 65-70. –£—Ä–æ–≤–µ–Ω—å 2: –ü–æ–∏—Å–∫ –ø–æ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—é –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤.</p>
                        </div>

                        <!-- Semantic Match Threshold -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                <span class="flex items-center gap-1">
                                    <span class="material-symbols-outlined text-sm">psychology</span>
                                    –ü–æ—Ä–æ–≥ —Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–æ–∏—Å–∫–∞ (%)
                                </span>
                            </label>
                            <input type="number" id="semantic_match_threshold" min="30" max="80" step="5" value="45" class="form-input w-full rounded-lg border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white">
                            <p class="text-xs text-gray-500 mt-1">–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è: 45. –£—Ä–æ–≤–µ–Ω—å 3: –°–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–π AI-–ø–æ–∏—Å–∫.</p>
                        </div>

                        <!-- Keyword Search Max Words -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                <span class="flex items-center gap-1">
                                    <span class="material-symbols-outlined text-sm">article</span>
                                    –ú–∞–∫—Å. —Å–ª–æ–≤ –¥–ª—è keyword search
                                </span>
                            </label>
                            <input type="number" id="keyword_search_max_words" min="3" max="10" step="1" value="5" class="form-input w-full rounded-lg border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white">
                            <p class="text-xs text-gray-500 mt-1">–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è: 5. –ï—Å–ª–∏ –∑–∞–ø—Ä–æ—Å –¥–ª–∏–Ω–Ω–µ–µ, keyword search –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç—Å—è.</p>
                        </div>
                    </div>

                    <!-- Show Similarity Toggle -->
                    <div class="mt-4">
                        <label class="flex items-center gap-3 cursor-pointer">
                            <input type="checkbox" id="show_similarity" class="w-5 h-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                            <span class="text-sm font-medium text-gray-700 dark:text-gray-300">
                                <span class="flex items-center gap-1">
                                    <span class="material-symbols-outlined text-sm">percent</span>
                                    –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –ø—Ä–æ—Ü–µ–Ω—Ç —Å—Ö–æ–∂–µ—Å—Ç–∏ –≤ –æ—Ç–≤–µ—Ç–∞—Ö
                                </span>
                            </span>
                        </label>
                        <p class="text-xs text-gray-500 mt-1 ml-8">–ï—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–æ, –≤ –æ—Ç–≤–µ—Ç–∞—Ö –±–æ—Ç–∞ –±—É–¥–µ—Ç –ø–æ–∫–∞–∑–∞–Ω–∞ –∏–∫–æ–Ω–∫–∞ —É—Ä–æ–≤–Ω—è –∏ –ø—Ä–æ—Ü–µ–Ω—Ç —Å—Ö–æ–∂–µ—Å—Ç–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä: üß† –°–æ–≤–ø–∞–¥–µ–Ω–∏–µ: 75%)</p>
                    </div>

                    <!-- Fallback Message -->
                    <div class="mt-4">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            <span class="flex items-center gap-1">
                                <span class="material-symbols-outlined text-sm">error</span>
                                –°–æ–æ–±—â–µ–Ω–∏–µ –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –æ—Ç–≤–µ—Ç–∞
                            </span>
                        </label>
                        <textarea id="fallback_message" rows="4" class="form-input w-full rounded-lg border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white"></textarea>
                        <p class="text-xs text-gray-500 mt-1">–°–æ–æ–±—â–µ–Ω–∏–µ, –∫–æ—Ç–æ—Ä–æ–µ —É–≤–∏–¥–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å, –µ—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –Ω–∞ –≤—Å–µ—Ö —É—Ä–æ–≤–Ω—è—Ö –ø–æ–∏—Å–∫–∞.</p>
                    </div>

                    <div class="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-4 mt-4">
                        <p class="text-sm text-blue-900 dark:text-blue-200">
                            <strong>‚ÑπÔ∏è –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–∞—Å–∫–∞–¥–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞:</strong>
                        </p>
                        <ol class="text-sm text-blue-800 dark:text-blue-300 mt-2 ml-4 list-decimal space-y-1">
                            <li><strong>–£—Ä–æ–≤–µ–Ω—å 1:</strong> –ò—â–µ–º —Ç–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ –≤–æ–ø—Ä–æ—Å–∞ (—Å–∞–º—ã–π –±—ã—Å—Ç—Ä—ã–π)</li>
                            <li><strong>–£—Ä–æ–≤–µ–Ω—å 2:</strong> –ò—â–µ–º –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º (—Ç–æ–ª—å–∫–æ –¥–ª—è –∫–æ—Ä–æ—Ç–∫–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤)</li>
                            <li><strong>–£—Ä–æ–≤–µ–Ω—å 3:</strong> –°–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–π AI-–ø–æ–∏—Å–∫ (—Å–∞–º—ã–π —É–º–Ω—ã–π, –Ω–æ –º–µ–¥–ª–µ–Ω–Ω—ã–π)</li>
                            <li><strong>–£—Ä–æ–≤–µ–Ω—å 4:</strong> –ü–æ–∫–∞–∑—ã–≤–∞–µ–º fallback-—Å–æ–æ–±—â–µ–Ω–∏–µ –µ—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</li>
                        </ol>
                    </div>
                </div>

                <!-- –î–µ–π—Å—Ç–≤–∏—è -->
                <div class="flex gap-3 justify-end pt-4">
                    <button type="button" onclick="resetSettings()" class="flex items-center gap-2 px-5 py-2 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600 transition-colors">
                        <span class="material-symbols-outlined">restart_alt</span>
                        <span>–°–±—Ä–æ—Å–∏—Ç—å –∫ —É–º–æ–ª—á–∞–Ω–∏—è–º</span>
                    </button>
                    <button type="submit" class="flex items-center gap-2 px-5 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors">
                        <span class="material-symbols-outlined">save</span>
                        <span>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</span>
                    </button>
                </div>
            </form>
        </div>
    </main>
</div>

<script>
    // –ë–∞–∑–æ–≤—ã–π URL –¥–ª—è API –∑–∞–ø—Ä–æ—Å–æ–≤ (—Å —É—á–µ—Ç–æ–º BASE_PATH –¥–ª—è reverse proxy)
    const BASE_URL = '{{ config.get("BASE_PATH", "") }}/admin';
    const editors = {};

    // ========== –§–£–ù–ö–¶–ò–ò –î–õ–Ø –°–ê–ô–î–ë–ê–†–ê ==========

    // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–∞–π–¥–±–∞—Ä–∞ (—Å–≤–µ—Ä–Ω—É—Ç/—Ä–∞–∑–≤–µ—Ä–Ω—É—Ç)
    function toggleSidebar() {
        const sidebar = document.getElementById('sidebar');
        const isExpanded = sidebar.classList.contains('sidebar-expanded');

        if (isExpanded) {
            sidebar.classList.remove('sidebar-expanded');
            sidebar.classList.add('sidebar-collapsed');
            localStorage.setItem('sidebarState', 'collapsed');
        } else {
            sidebar.classList.remove('sidebar-collapsed');
            sidebar.classList.add('sidebar-expanded');
            localStorage.setItem('sidebarState', 'expanded');
        }
    }

    // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–∞–π–¥–±–∞—Ä–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    function restoreSidebarState() {
        const savedState = localStorage.getItem('sidebarState');
        if (savedState === 'collapsed') {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.remove('sidebar-expanded');
            sidebar.classList.add('sidebar-collapsed');
        }
    }

    // –í—ã–∑—ã–≤–∞–µ–º –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    restoreSidebarState();

    // ========== –ö–û–ù–ï–¶ –§–£–ù–ö–¶–ò–ô –î–õ–Ø –°–ê–ô–î–ë–ê–†–ê ==========

    // –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è Quill HTML –≤ Telegram HTML
    function convertQuillToTelegramHtml(html) {
        html = html.replace(/<strong>/g, '<b>');
        html = html.replace(/<\/strong>/g, '</b>');
        html = html.replace(/<em>/g, '<i>');
        html = html.replace(/<\/em>/g, '</i>');
        html = html.replace(/<pre class="ql-syntax"[^>]*>/g, '<code>');
        html = html.replace(/<\/pre>/g, '</code>');
        html = html.replace(/<p><br><\/p>/g, '\n');
        html = html.replace(/<p>/g, '');
        html = html.replace(/<\/p>/g, '\n');
        html = html.replace(/<br>/g, '\n');
        html = html.replace(/<br\/>/g, '\n');
        html = html.replace(/<br \/>/g, '\n');
        html = html.replace(/\n+$/g, '');
        return html;
    }

    // –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è Telegram HTML –≤ Quill HTML
    function convertTelegramToQuillHtml(html) {
        if (!html) return '<p><br></p>';
        html = html.replace(/<b>/g, '<strong>');
        html = html.replace(/<\/b>/g, '</strong>');
        html = html.replace(/<i>/g, '<em>');
        html = html.replace(/<\/i>/g, '</em>');
        html = html.replace(/<code>/g, '<code class="ql-code">');
        const lines = html.split('\n');
        const paragraphs = lines.map(line => {
            if (line.trim() === '') return '<p><br></p>';
            return '<p>' + line + '</p>';
        });
        return paragraphs.join('');
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Quill —Ä–µ–¥–∞–∫—Ç–æ—Ä–æ–≤
    function initWysiwygEditors() {
        if (Object.keys(editors).length > 0) return;

        const editorConfigs = [
            { id: "start_message", containerId: "start_message_editor" },
            { id: "feedback_response_yes", containerId: "feedback_response_yes_editor" },
            { id: "feedback_response_no", containerId: "feedback_response_no_editor" },
        ];

        editorConfigs.forEach((config) => {
            const container = document.getElementById(config.containerId);
            const textarea = document.getElementById(config.id);

            const quill = new Quill(`#${config.containerId}`, {
                theme: "snow",
                modules: {
                    toolbar: [
                        ["bold", "italic", "underline", "strike"],
                        ["code-block"],
                        ["clean"],
                    ],
                },
                placeholder: "–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç...",
            });

            editors[config.id] = quill;

            quill.on("text-change", () => {
                let html = quill.root.innerHTML;
                html = convertQuillToTelegramHtml(html);
                textarea.value = html;
                updatePreview(config.id, config.id + "_preview");
            });
        });
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫
    async function loadSettings() {
        try {
            const response = await fetchWithAuth(`${BASE_URL}/api/settings`);
            const data = await response.json();

            if (data.success) {
                const settings = data.settings;

                document.getElementById("feedback_button_yes").value = settings.feedback_button_yes || "";
                document.getElementById("feedback_button_no").value = settings.feedback_button_no || "";

                // –ö–∞—Å–∫–∞–¥–Ω—ã–π –ø–æ–∏—Å–∫
                document.getElementById("exact_match_threshold").value = settings.exact_match_threshold || "95";
                document.getElementById("keyword_match_threshold").value = settings.keyword_match_threshold || "80";
                document.getElementById("semantic_match_threshold").value = settings.semantic_match_threshold || "45";
                document.getElementById("keyword_search_max_words").value = settings.keyword_search_max_words || "5";
                document.getElementById("show_similarity").checked = settings.show_similarity !== "false";
                document.getElementById("fallback_message").value = settings.fallback_message || "";

                initWysiwygEditors();

                if (editors["start_message"]) {
                    const quillHtml = convertTelegramToQuillHtml(settings.start_message || "");
                    editors["start_message"].root.innerHTML = quillHtml;
                    const html = convertQuillToTelegramHtml(editors["start_message"].root.innerHTML);
                    document.getElementById("start_message").value = html;
                }
                if (editors["feedback_response_yes"]) {
                    const quillHtml = convertTelegramToQuillHtml(settings.feedback_response_yes || "");
                    editors["feedback_response_yes"].root.innerHTML = quillHtml;
                    const html = convertQuillToTelegramHtml(editors["feedback_response_yes"].root.innerHTML);
                    document.getElementById("feedback_response_yes").value = html;
                }
                if (editors["feedback_response_no"]) {
                    const quillHtml = convertTelegramToQuillHtml(settings.feedback_response_no || "");
                    editors["feedback_response_no"].root.innerHTML = quillHtml;
                    const html = convertQuillToTelegramHtml(editors["feedback_response_no"].root.innerHTML);
                    document.getElementById("feedback_response_no").value = html;
                }

                updateAllPreviews();

                document.getElementById("loadingIndicator").style.display = "none";
                document.getElementById("settingsForm").style.display = "block";
            } else {
                showNotification("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫: " + data.message, "error");
            }
        } catch (error) {
            showNotification("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫: " + error.message, "error");
        }
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞
    function updatePreview(inputId, previewId) {
        const input = document.getElementById(inputId);
        const preview = document.getElementById(previewId);
        let text = input.value;

        if (inputId.includes("button")) {
            preview.textContent = text;
            return;
        }

        text = text.replace(/\n/g, "<br>");
        preview.innerHTML = text;
    }

    function updateAllPreviews() {
        updatePreview("start_message", "start_message_preview");
        updatePreview("feedback_button_yes", "feedback_button_yes_preview");
        updatePreview("feedback_button_no", "feedback_button_no_preview");
        updatePreview("feedback_response_yes", "feedback_response_yes_preview");
        updatePreview("feedback_response_no", "feedback_response_no_preview");
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –æ–±—ã—á–Ω—ã—Ö input –ø–æ–ª–µ–π
    document.addEventListener("DOMContentLoaded", () => {
        const inputs = ["feedback_button_yes", "feedback_button_no"];

        inputs.forEach((inputId) => {
            const element = document.getElementById(inputId);
            element.addEventListener("input", () => {
                updatePreview(inputId, inputId + "_preview");
            });
        });
    });

    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫
    document.getElementById("settingsForm").addEventListener("submit", async (e) => {
        e.preventDefault();

        const settings = {
            start_message: document.getElementById("start_message").value,
            feedback_button_yes: document.getElementById("feedback_button_yes").value,
            feedback_button_no: document.getElementById("feedback_button_no").value,
            feedback_response_yes: document.getElementById("feedback_response_yes").value,
            feedback_response_no: document.getElementById("feedback_response_no").value,

            // –ö–∞—Å–∫–∞–¥–Ω—ã–π –ø–æ–∏—Å–∫
            exact_match_threshold: document.getElementById("exact_match_threshold").value,
            keyword_match_threshold: document.getElementById("keyword_match_threshold").value,
            semantic_match_threshold: document.getElementById("semantic_match_threshold").value,
            keyword_search_max_words: document.getElementById("keyword_search_max_words").value,
            show_similarity: document.getElementById("show_similarity").checked ? "true" : "false",
            fallback_message: document.getElementById("fallback_message").value,
        };

        try {
            showNotification("–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫...", "info");

            const response = await fetchWithAuth(`${BASE_URL}/api/settings`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ settings }),
            });

            const data = await response.json();

            if (data.success) {
                showNotification("‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!", "success");
            } else {
                showNotification("‚ùå –û—à–∏–±–∫–∞: " + data.message, "error");
            }
        } catch (error) {
            showNotification("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏: " + error.message, "error");
        }
    });

    // –°–±—Ä–æ—Å –Ω–∞—Å—Ç—Ä–æ–µ–∫
    async function resetSettings() {
        if (!confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —Å–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∫ –∑–Ω–∞—á–µ–Ω–∏—è–º –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é?")) {
            return;
        }

        try {
            showNotification("–°–±—Ä–æ—Å –Ω–∞—Å—Ç—Ä–æ–µ–∫...", "info");

            const response = await fetchWithAuth(`${BASE_URL}/api/settings/reset`, {
                method: "POST",
            });

            const data = await response.json();

            if (data.success) {
                showNotification("‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–±—Ä–æ—à–µ–Ω—ã!", "success");
                setTimeout(() => {
                    loadSettings();
                }, 1000);
            } else {
                showNotification("‚ùå –û—à–∏–±–∫–∞: " + data.message, "error");
            }
        } catch (error) {
            showNotification("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–±—Ä–æ—Å–µ: " + error.message, "error");
        }
    }

    // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
    function showNotification(message, type) {
        const notification = document.createElement("div");
        notification.className = `fixed top-5 right-5 px-6 py-3 rounded-lg shadow-lg z-[100] text-white font-medium ${
            type === 'success' ? 'bg-green-500' :
            type === 'error' ? 'bg-red-500' :
            'bg-blue-500'
        }`;
        notification.textContent = message;
        document.body.appendChild(notification);

        setTimeout(() => notification.remove(), 3000);
    }

    // –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    loadSettings();
</script>
</body>
</html>
