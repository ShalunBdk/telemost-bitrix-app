<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–í–∏–¥–µ–æ–∫–æ–Ω—Ñ–µ—Ä–µ–Ω—Ü–∏–∏ –¢–µ–ª–µ–º–æ—Å—Ç ‚Äî –ë–∏—Ç—Ä–∏–∫—Å24</title>

  <!-- Bitrix24 SDK -->
  <script src="//api.bitrix24.com/api/v1/"></script>

  <!-- Tailwind CSS (production build) -->
  <link rel="stylesheet" href="{{ config.BASE_PATH }}/static/css/output.css">

  <!-- Vue 3 (global build) -->
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
</head>
<body class="bg-gradient-to-br from-gray-50 to-gray-100 min-h-screen p-6">

  <div id="app" class="max-w-7xl mx-auto">
    <!-- Header -->
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-8">
      <div>
        <h1 class="text-3xl md:text-4xl font-bold text-gray-900 mb-2">–í–∏–¥–µ–æ–∫–æ–Ω—Ñ–µ—Ä–µ–Ω—Ü–∏–∏ –¢–µ–ª–µ–º–æ—Å—Ç</h1>
        <p class="text-gray-600">–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –ë–∏—Ç—Ä–∏–∫—Å24</p>
      </div>

      <div class="flex items-center gap-3">
        <!-- Auth status indicators -->
        <div class="flex items-center gap-2 text-sm">
          <div :class="['w-3 h-3 rounded-full', bitrixAuth ? 'bg-green-500' : 'bg-red-500']"></div>
          <span>–ë–∏—Ç—Ä–∏–∫—Å24</span>
        </div>
        <div class="flex items-center gap-2 text-sm">
          <div :class="['w-3 h-3 rounded-full', telemostAuth ? 'bg-green-500' : 'bg-red-500']"></div>
          <span>–¢–µ–ª–µ–º–æ—Å—Ç</span>
        </div>

        <!-- Auth buttons -->
        <template v-if="!bitrixAuth">
          <a href="{{ config.BASE_PATH }}/auth/bitrix24" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">–ü–æ–¥–∫–ª—é—á–∏—Ç—å –ë–∏—Ç—Ä–∏–∫—Å24</a>
        </template>

        <!-- Create button -->
        <template v-else>
          <div class="relative inline-block">
            <button @click.stop="showCreateMenu = !showCreateMenu"
                    class="flex items-center gap-2 px-5 py-2 bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-lg shadow">
              <span class="text-lg">Ôºã</span>
              –°–æ–∑–¥–∞—Ç—å
              <svg class="w-4 h-4" viewBox="0 0 20 20" fill="none" stroke="currentColor"><path d="M6 8l4 4 4-4" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
            </button>

            <transition name="fade">
              <div v-if="showCreateMenu" @click.stop class="absolute right-0 mt-2 w-80 bg-white rounded-xl shadow-2xl border overflow-hidden" style="z-index: 1000;">
                <button @click="openCreateModal('conference')"
                        class="w-full px-5 py-4 text-left hover:bg-blue-50 flex items-start gap-3 border-b">
                  <div class="p-2 rounded-lg">
                    <div class="w-3 h-3 rounded-full bg-blue-500"></div>
                  </div>
                  <div class="flex-1">
                    <div class="font-semibold text-gray-900">–ö–æ–Ω—Ñ–µ—Ä–µ–Ω—Ü–∏—è</div>
                    <div class="text-sm text-gray-500 mt-1">–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –≤—Å—Ç—Ä–µ—á–∞</div>
                  </div>
                </button>
                <button @click="openCreateModal('broadcast')"
                        class="w-full px-5 py-4 text-left hover:bg-purple-50 flex items-start gap-3">
                  <div class="p-2 rounded-lg">
                    <div class="w-3 h-3 rounded-full bg-purple-500"></div>
                  </div>
                  <div class="flex-1">
                    <div class="font-semibold text-gray-900">–¢—Ä–∞–Ω—Å–ª—è—Ü–∏—è</div>
                    <div class="text-sm text-gray-500 mt-1">–í–µ–±–∏–Ω–∞—Ä –¥–ª—è –∞—É–¥–∏—Ç–æ—Ä–∏–∏</div>
                  </div>
                </button>
              </div>
            </transition>
          </div>
        </template>
      </div>
    </div>

    <!-- Main content area, shown if Bitrix24 is authenticated -->
    {% raw %}
    <template v-if="bitrixAuth">
      <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-8">
        <div></div>
        </div>
      </div>

      <!-- Tabs -->
      <div class="flex gap-2 mb-6 border-b border-gray-200 overflow-x-auto">
        <button v-for="(t, i) in tabs" :key="i" @click="selectedTab = i"
                :class="['flex items-center gap-2 px-5 py-3 border-b-2 whitespace-nowrap', selectedTab === i ? 'border-blue-600 text-blue-600 font-semibold' : 'border-transparent text-gray-600 hover:text-gray-900 hover:border-gray-300']">
          <span v-if="t.icon" class="text-base">{{ t.icon }}</span>
          {{ t.label }}
          <span :class="['px-2.5 py-0.5 text-xs font-medium rounded-full', selectedTab === i ? 'bg-blue-100 text-blue-700' : 'bg-gray-100 text-gray-600']">
            {{ tabCount(i) }}
          </span>
        </button>
      </div>

      <!-- Search -->
      <div class="mb-6">
        <div class="relative">
          <span class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400">üîé</span>
          <input type="text" v-model="searchQuery" placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –∏–ª–∏ –≤–ª–∞–¥–µ–ª—å—Ü—É..."
                 class="w-full pl-12 pr-4 py-3.5 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 shadow-sm" />
        </div>
      </div>

      <!-- Table -->
      <div class="bg-white rounded-xl shadow-lg border border-gray-200">
        <div class="overflow-x-auto">
          <table class="w-full">
            <thead class="bg-gray-50 border-b border-gray-200">
              <tr>
                <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase">–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</th>
                <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase">–°–æ–∑–¥–∞–Ω–æ</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-gray-200">
              <tr v-for="conf in filteredConferences" :key="conf.id" class="hover:bg-gray-50 transition-colors">
                <td class="px-6 py-4">
                  <div class="flex items-center gap-3">
                    <div :class="['p-2 rounded-lg', conf.type === 'conference' ? 'bg-blue-100' : 'bg-purple-100']">
                      <div :class="['w-3 h-3 rounded-full', conf.type === 'conference' ? 'bg-blue-500' : 'bg-purple-500']"></div>
                    </div>
                    <div>
                      <div class="flex items-center gap-2">
                        <span class="font-medium text-gray-900">{{ conf.name }}</span>
                        <span :class="['px-2.5 py-1 text-xs font-medium rounded-full', conf.type === 'conference' ? 'bg-blue-100 text-blue-700' : 'bg-purple-100 text-purple-700']">
                          {{ conf.type === 'conference' ? '–ö–æ–Ω—Ñ–µ—Ä–µ–Ω—Ü–∏—è' : '–¢—Ä–∞–Ω—Å–ª—è—Ü–∏—è' }}
                        </span>
                      </div>
                    </div>
                  </div>
                </td>

                <td class="px-6 py-4">
                  <div class="flex items-center gap-2 flex-wrap">
                    <button @click="start(conf.link)" class="flex items-center gap-2 px-4 py-2 bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-lg text-sm font-medium shadow-sm">
                      ‚ñ∂Ô∏è {{ conf.type === 'conference' ? '–ù–ê–ß–ê–¢–¨' : '–¢–†–ê–ù–°–õ–Ø–¶–ò–Æ' }}
                    </button>

                    <button @click="copyLink(conf.link)" class="px-4 py-2 border-2 border-gray-300 rounded-lg hover:bg-gray-50 text-sm font-medium flex items-center gap-2">
                      üîó –°–°–´–õ–ö–ê
                    </button>

                    <div class="relative">
                      <button @click.stop="toggleMenu(conf.id, $event)" class="p-2 hover:bg-gray-100 rounded-lg transition-colors">‚ãØ</button>
                    </div>
                  </div>
                </td>

                <td class="px-6 py-4">
                  {{ formatDate(conf.createdAt) }}
                </td>
              </tr>
              <tr v-if="filteredConferences.length === 0">
                <td colspan="3" class="px-6 py-6 text-center text-gray-500">
                  <div v-if="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                  <div v-else>–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Stats -->
      <div class="flex justify-between items-center mt-6 text-sm text-gray-600">
        <div class="font-medium">–í—Å–µ–≥–æ: <span class="text-gray-900 font-semibold">{{ filteredConferences.length }}</span></div>
      </div>

      <!-- Dropdown menu (teleported to body) -->
      <teleport to="body">
        <div v-if="openMenuId !== null" @click.stop
             :style="{ position: 'fixed', top: menuPosition.top + 'px', left: menuPosition.left + 'px', zIndex: 9999 }"
             class="w-48 bg-white rounded-lg shadow-2xl border">
          <button @click="editFromMenu(); closeMenu()" class="w-full px-4 py-2.5 text-left hover:bg-gray-50 flex items-center gap-2.5 border-b text-sm">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
          <button @click="deleteFromMenu(); closeMenu()" class="w-full px-4 py-2.5 text-left hover:bg-red-50 flex items-center gap-2.5 text-red-600 text-sm rounded-b-lg">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
        </div>
      </teleport>
    </template>

    <!-- Auth required message -->
    <template v-else>
      <div class="bg-white rounded-xl shadow-lg p-8 text-center">
        <h2 class="text-2xl font-bold text-gray-800 mb-4">–¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è</h2>
        <p class="text-gray-600 mb-6">–î–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –ø–æ–¥–∫–ª—é—á–∏—Ç—å –ë–∏—Ç—Ä–∏–∫—Å24:</p>

        <div class="flex flex-col sm:flex-row gap-4 justify-center">
          <a href="{{ config.BASE_PATH }}/auth/bitrix24" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium">
            –ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è –≤ –ë–∏—Ç—Ä–∏–∫—Å24
          </a>
        </div>
      </div>
    </template>

    <!-- Create Modal -->
    <transition name="fade">
      <div v-if="isCreateModalOpen" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4" style="z-index: 10000;">
        <div class="bg-white rounded-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto shadow-2xl">
          <div class="sticky top-0 bg-white p-6 border-b border-gray-200 flex justify-between items-center rounded-t-2xl">
            <h2 class="text-2xl font-bold text-gray-900">{{ newConference.type === 'conference' ? '–°–æ–∑–¥–∞—Ç—å –∫–æ–Ω—Ñ–µ—Ä–µ–Ω—Ü–∏—é' : '–°–æ–∑–¥–∞—Ç—å —Ç—Ä–∞–Ω—Å–ª—è—Ü–∏—é' }}</h2>
            <button @click="closeModal" class="p-2 hover:bg-gray-100 rounded-lg">‚úñÔ∏è</button>
          </div>

          <div class="p-6 space-y-6">
            <!-- Info -->
            <div :class="['p-4 rounded-xl flex gap-3', newConference.type === 'conference' ? 'bg-gradient-to-r from-blue-50 to-blue-100 border-2 border-blue-200' : 'bg-gradient-to-r from-purple-50 to-purple-100 border-2 border-purple-200']">
              <div class="text-2xl flex-shrink-0">‚Ä¢</div>
              <div>
                <div class="font-semibold text-gray-900 mb-1">{{ newConference.type === 'conference' ? '–í–∏–¥–µ–æ–∫–æ–Ω—Ñ–µ—Ä–µ–Ω—Ü–∏—è' : '–¢—Ä–∞–Ω—Å–ª—è—Ü–∏—è' }}</div>
                <div class="text-sm text-gray-700">
                  {{ newConference.type === 'conference' ? '–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –≤—Å—Ç—Ä–µ—á–∞ —Å –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ —É—á–∞—Å—Ç–Ω–∏–∫–∞–º–∏.' : '–û–¥–Ω–æ—Å—Ç–æ—Ä–æ–Ω–Ω—è—è —Ç—Ä–∞–Ω—Å–ª—è—Ü–∏—è –¥–ª—è –∞—É–¥–∏—Ç–æ—Ä–∏–∏.' }}
                </div>
              </div>
            </div>

            <!-- –ù–∞–∑–≤–∞–Ω–∏–µ -->
            <div>
              <label class="block text-sm font-semibold text-gray-700 mb-2">–ù–∞–∑–≤–∞–Ω–∏–µ <span class="text-red-500">*</span></label>
              <input type="text" v-model="newConference.name" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ"
                     class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" />
            </div>

            <!-- –°–æ–æ—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä—ã -->
            <div class="pt-2">
              <label class="block text-sm font-semibold text-gray-700 mb-2">–°–æ–æ—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä—ã (–¥–æ 30)</label>
              <input type="text" ref="cohostInput" placeholder="email@example.com (–Ω–∞–∂–º–∏—Ç–µ Enter)"
                     @keypress.enter.prevent="addCohost"
                     class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" />
              <div class="flex flex-wrap gap-2 mt-3" v-if="newConference.cohosts.length">
                <span v-for="(email, idx) in newConference.cohosts" :key="idx" class="inline-flex items-center gap-1 px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm">
                  {{ email }}
                  <button @click="removeCohost(idx)" class="ml-1 hover:bg-blue-200 rounded-full p-0.5">‚úñÔ∏è</button>
                </span>
              </div>
            </div>

            <!-- Actions -->
            <div class="flex justify-end gap-3 pt-6 border-t-2 border-gray-100">
              <button @click="closeModal" class="px-6 py-3 border-2 border-gray-300 rounded-lg hover:bg-gray-50">–û—Ç–º–µ–Ω–∞</button>
              <button @click="handleCreateConference"
                      class="px-6 py-3 text-white rounded-lg bg-gradient-to-r from-blue-600 to-blue-700 flex items-center gap-2 font-semibold shadow-lg">
                {{ creatingConference ? '–°–æ–∑–¥–∞–Ω–∏–µ...' : (newConference.type === 'conference' ? '–°–æ–∑–¥–∞—Ç—å –∫–æ–Ω—Ñ–µ—Ä–µ–Ω—Ü–∏—é' : '–°–æ–∑–¥–∞—Ç—å —Ç—Ä–∞–Ω—Å–ª—è—Ü–∏—é') }}
              </button>
            </div>

          </div>
        </div>
      </div>
    </transition>
    {% endraw %}
  </div>

  <script>
    // Base path from Flask config for reverse proxy support
    const BASE_PATH = '{{ config.BASE_PATH }}';

    const { createApp, ref, reactive, computed, onMounted } = Vue;

    createApp({
      setup() {
        const searchQuery = ref('');
        const selectedTab = ref(0);
        const isCreateModalOpen = ref(false);
        const showCreateMenu = ref(false);
        const loading = ref(false);
        const creatingConference = ref(false);
        const openMenuId = ref(null);
        const menuPosition = ref({ top: 0, left: 0 });
        const selectedConf = ref(null);
        const currentUser = ref(null); // –î–∞–Ω–Ω—ã–µ —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ BX24
        const isInitialized = ref(false); // –§–ª–∞–≥ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ BX24

        // Get auth status from Flask template
        const bitrixAuth = {{ bitrix_auth | tojson }};
        const telemostAuth = {{ telemost_auth | tojson }};

        const conferences = ref([
          // Will be populated from API
        ]);

        // –§—É–Ω–∫—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —á–µ—Ä–µ–∑ BX24 SDK
        const getCurrentUserFromBX24 = () => {
          return new Promise((resolve, reject) => {
            if (!window.BX24) {
              reject(new Error('Bitrix24 SDK –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω'));
              return;
            }

            BX24.callMethod('user.current', {}, (result) => {
              if (result.error()) {
                console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', result.error());
                reject(result.error());
              } else {
                const user = result.data();
                resolve({
                  id: String(user.ID),
                  name: `${user.NAME || ''} ${user.LAST_NAME || ''}`.trim() || user.EMAIL || 'Unknown User'
                });
              }
            });
          });
        };

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Bitrix24 SDK
        const initializeBX24 = async () => {
          return new Promise((resolve) => {
            if (!window.BX24) {
              console.warn('Bitrix24 SDK –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, —Ä–∞–±–æ—Ç–∞–µ–º –±–µ–∑ SDK');
              isInitialized.value = true;
              resolve(false);
              return;
            }

            BX24.init(() => {
              console.log('Bitrix24 SDK –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
              isInitialized.value = true;
              resolve(true);
            });
          });
        };

        const defaultNew = () => ({
          type: 'conference',
          name: '',
          cohosts: []
        });

        const newConference = reactive(defaultNew());

        const tabs = [
          { label: '–í—Å–µ', icon: null },
          { label: '–ö–æ–Ω—Ñ–µ—Ä–µ–Ω—Ü–∏–∏', icon: 'üé•' },
          { label: '–¢—Ä–∞–Ω—Å–ª—è—Ü–∏–∏', icon: 'üì°' }
        ];

        const filteredConferences = computed(() => {
          let list = conferences.value.slice();
          if (selectedTab.value === 1) list = list.filter(c => c.type === 'conference');
          else if (selectedTab.value === 2) list = list.filter(c => c.type === 'broadcast');

          if (searchQuery.value && searchQuery.value.trim()) {
            const q = searchQuery.value.trim().toLowerCase();
            list = list.filter(conf =>
              conf.name.toLowerCase().includes(q)
            );
          }
          return list;
        });

        const statusColor = (status) => {
          const m = {
            scheduled: 'bg-blue-100 text-blue-800',
            live: 'bg-green-100 text-green-800',
            completed: 'bg-gray-100 text-gray-800',
            cancelled: 'bg-red-100 text-red-800'
          };
          return m[status] || 'bg-gray-100 text-gray-800';
        };

        const statusText = (status) => {
          const m = { 
            scheduled: '–ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∞', 
            live: 'üî¥ –í —ç—Ñ–∏—Ä–µ', 
            completed: '–ó–∞–≤–µ—Ä—à–µ–Ω–∞', 
            cancelled: '–û—Ç–º–µ–Ω–µ–Ω–∞' 
          };
          return m[status] || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
        };

        const openCreateModal = (type) => {
          if (!telemostAuth) {
            showToast('–î–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –≤—Å—Ç—Ä–µ—á –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –ø–æ–¥–∫–ª—é—á–∏—Ç—å –Ø–Ω–¥–µ–∫—Å –¢–µ–ª–µ–º–æ—Å—Ç (–æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É)', 'error');
            return;
          }
          Object.assign(newConference, defaultNew());
          newConference.type = type;
          isCreateModalOpen.value = true;
          showCreateMenu.value = false;
          closeMenu(); // Close dropdown menu if open
        };

        const closeModal = () => {
          isCreateModalOpen.value = false;
          Object.assign(newConference, defaultNew());
          creatingConference.value = false;
        };

        const handleCreateConference = async () => {
          if (!newConference.name.trim()) {
            showToast('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ', 'error');
            return;
          }

          creatingConference.value = true;

          try {
            const response = await fetch(buildApiUrl('/api/conferences'), {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({
                type: newConference.type,
                name: newConference.name,
                cohosts: newConference.cohosts
              })
            });

            const result = await response.json();

            if (response.ok) {
              // Add to local list and close modal
              conferences.value.unshift({
                id: result.id || conferences.value.length ? Math.max(...conferences.value.map(c => c.id)) + 1 : 1,
                name: newConference.name,
                type: newConference.type,
                ownerId: 1,
                link: result.link || `https://telemost.yandex.ru/j/${Math.random().toString(36).substr(2,9)}`,
                createdAt: new Date()
              });

              closeModal();
              showToast('–ö–æ–Ω—Ñ–µ—Ä–µ–Ω—Ü–∏—è —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞!', 'success');
            } else {
              // In demo mode, just add to local list if Yandex is not connected
              if (result.connected === false) {
                // Add to local list for demo purposes
                conferences.value.unshift({
                  id: conferences.value.length ? Math.max(...conferences.value.map(c => c.id)) + 1 : 1,
                  name: newConference.name,
                  type: newConference.type,
                  ownerId: 1,
                  link: `https://telemost.yandex.ru/j/${Math.random().toString(36).substr(2,9)}`,
                  createdAt: new Date()
                });

                closeModal();
                showToast('–ö–æ–Ω—Ñ–µ—Ä–µ–Ω—Ü–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ –¥–µ–º–æ-—Ä–µ–∂–∏–º–µ. –î–ª—è –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω–æ–≥–æ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —Ç—Ä–µ–±—É–µ—Ç—Å—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –Ø–Ω–¥–µ–∫—Å –¢–µ–ª–µ–º–æ—Å—Ç.', 'warning');
              } else {
                showToast('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∫–æ–Ω—Ñ–µ—Ä–µ–Ω—Ü–∏–∏: ' + (result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'), 'error');
              }
            }
          } catch (error) {
            showToast('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∫–æ–Ω—Ñ–µ—Ä–µ–Ω—Ü–∏–∏: ' + error.message, 'error');
          } finally {
            creatingConference.value = false;
          }
        };

        const copyLink = (link) => {
          // Use fallback method for iframe compatibility (Clipboard API is blocked in iframes)
          const textArea = document.createElement('textarea');
          textArea.value = link;
          textArea.style.position = 'fixed';
          textArea.style.left = '-999999px';
          textArea.style.top = '-999999px';
          document.body.appendChild(textArea);
          textArea.focus();
          textArea.select();

          try {
            const successful = document.execCommand('copy');
            if (successful) {
              showToast('‚úì –°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!', 'success');
            } else {
              showToast('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É', 'error');
            }
          } catch (err) {
            console.error('Copy failed', err);
            showToast('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É: ' + err.message, 'error');
          } finally {
            document.body.removeChild(textArea);
          }
        };

        const deleteConference = async (id) => {
          if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å?')) {
            try {
              const response = await fetch(buildApiUrl(`/api/conferences/${id}`), {
                method: 'DELETE'
              });

              const result = await response.json();

              if (response.ok) {
                conferences.value = conferences.value.filter(c => c.id !== id);
                showToast('–ö–æ–Ω—Ñ–µ—Ä–µ–Ω—Ü–∏—è —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω–∞!', 'success');
              } else {
                // If Yandex is not connected, just remove from local list
                if (result.connected === false) {
                  conferences.value = conferences.value.filter(c => c.id !== id);
                  showToast('–ö–æ–Ω—Ñ–µ—Ä–µ–Ω—Ü–∏—è —É–¥–∞–ª–µ–Ω–∞ –≤ –¥–µ–º–æ-—Ä–µ–∂–∏–º–µ. –î–ª—è –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω–æ–≥–æ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —Ç—Ä–µ–±—É–µ—Ç—Å—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –Ø–Ω–¥–µ–∫—Å –¢–µ–ª–µ–º–æ—Å—Ç.', 'warning');
                } else {
                  showToast('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∫–æ–Ω—Ñ–µ—Ä–µ–Ω—Ü–∏–∏: ' + (result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'), 'error');
                }
              }
            } catch (error) {
              // If there's a network error when Yandex is not connected, just remove from local list
              if (!telemostAuth) {
                conferences.value = conferences.value.filter(c => c.id !== id);
                showToast('–ö–æ–Ω—Ñ–µ—Ä–µ–Ω—Ü–∏—è —É–¥–∞–ª–µ–Ω–∞ –≤ –¥–µ–º–æ-—Ä–µ–∂–∏–º–µ. –î–ª—è –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω–æ–≥–æ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —Ç—Ä–µ–±—É–µ—Ç—Å—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –Ø–Ω–¥–µ–∫—Å –¢–µ–ª–µ–º–æ—Å—Ç.', 'warning');
              } else {
                showToast('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∫–æ–Ω—Ñ–µ—Ä–µ–Ω—Ü–∏–∏: ' + error.message, 'error');
              }
            }
          }
        };

        const tabCount = (index) => {
          if (index === 1) return conferences.value.filter(c => c.type === 'conference').length;
          if (index === 2) return conferences.value.filter(c => c.type === 'broadcast').length;
          return conferences.value.length;
        };

        const toggleMenu = (id, event) => {
          if (openMenuId.value === id) {
            closeMenu();
            return;
          }

          openMenuId.value = id;

          // Find the conference
          selectedConf.value = conferences.value.find(c => c.id === id);

          // Calculate menu position
          const button = event.currentTarget;
          const rect = button.getBoundingClientRect();

          // Menu width (w-48 = 12rem = 192px)
          const menuWidth = 192;

          // Position menu below and to the left of the button (fixed position, no scroll offset needed)
          let left = rect.right - menuWidth;

          // If menu would go off left edge, align it to the left of button
          if (left < 0) {
            left = rect.left;
          }

          menuPosition.value = {
            top: rect.bottom + 4,
            left: left
          };
        };

        const closeMenu = () => {
          openMenuId.value = null;
          selectedConf.value = null;
        };

        const editFromMenu = () => {
          if (selectedConf.value) {
            edit(selectedConf.value);
          }
        };

        const deleteFromMenu = () => {
          if (selectedConf.value) {
            deleteConference(selectedConf.value.id);
          }
        };

        const start = (link) => {
          window.open(link, '_blank');
        };

        const edit = (conf) => {
          // Fill form and open modal
          Object.assign(newConference, defaultNew());
          newConference.type = conf.type;
          newConference.name = conf.name;
          newConference.cohosts = conf.cohosts || [];
          isCreateModalOpen.value = true;
        };

        // Cohosts management
        const addCohost = (ev) => {
          const el = ev.target;
          const email = el.value && el.value.trim();
          if (!email) return;
          if (!email.includes('@')) {
            showToast('–ù–µ–≤–∞–ª–∏–¥–Ω—ã–π email', 'error');
            return;
          }
          if (newConference.cohosts.length >= 30) {
            showToast('–ú–∞–∫—Å–∏–º—É–º 30 —Å–æ–æ—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä–æ–≤', 'error');
            el.value = '';
            return;
          }
          newConference.cohosts.push(email);
          el.value = '';
        };
        
        const removeCohost = (idx) => {
          newConference.cohosts.splice(idx, 1);
        };

        // Helper function to build URL with user info and BASE_PATH
        const buildApiUrl = (path) => {
          // Add BASE_PATH prefix to the path
          const fullPath = BASE_PATH + path;
          const url = new URL(fullPath, window.location.origin);
          if (currentUser.value) {
            url.searchParams.set('user_id', currentUser.value.id);
            url.searchParams.set('user_name', currentUser.value.name);
          }
          return url.toString();
        };

        // Load conferences from API or demo data
        const loadConferences = async () => {
          loading.value = true;
          try {
            if (telemostAuth) {
              const response = await fetch(buildApiUrl('/api/conferences'));
              if (response.ok) {
                const data = await response.json();
                conferences.value = Array.isArray(data) ? data : (data.conferences || []);
              } else {
                console.error('Failed to load conferences:', response.status);
              }
            } else {
              // Load demo data for preview
              conferences.value = [
                { id: 1, name: '–¢–µ—Å—Ç–æ–≤–∞—è –≤–∏–¥–µ–æ–∫–æ–Ω—Ñ–µ—Ä–µ–Ω—Ü–∏—è', type: 'conference', ownerId: 1, link: 'https://telemost.yandex.ru/j/demo1', createdAt: new Date() },
                { id: 2, name: '–ü—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—è –ø—Ä–æ–¥—É–∫—Ç–∞', type: 'broadcast', ownerId: 2, link: 'https://telemost.yandex.ru/j/demo2', createdAt: new Date() },
                { id: 3, name: '–°–æ–≤–µ—â–∞–Ω–∏–µ –æ—Ç–¥–µ–ª–∞', type: 'conference', ownerId: 3, link: 'https://telemost.yandex.ru/j/demo3', createdAt: new Date() },
                { id: 4, name: '–í–µ–±–∏–Ω–∞—Ä –ø–æ –ø—Ä–æ–¥–∞–∂–∞–º', type: 'broadcast', ownerId: 2, link: 'https://telemost.yandex.ru/j/demo4', createdAt: new Date() }
              ];
            }
          } catch (error) {
            console.error('Error loading conferences:', error);
          } finally {
            loading.value = false;
          }
        };

        const formatDate = (dateStr) => {
          if (!dateStr) return '‚Äî';
          try {
            // Try different date formats
            let date;
            if (typeof dateStr === 'string') {
              // Handle ISO format or other common formats
              if (dateStr.includes('T')) {
                date = new Date(dateStr);
              } else {
                // Handle other formats like YYYY-MM-DD HH:MM:SS
                const parsed = Date.parse(dateStr);
                if (!isNaN(parsed)) {
                  date = new Date(parsed);
                } else {
                  // If all else fails, return original string
                  return dateStr;
                }
              }
            } else if (dateStr instanceof Date) {
              date = dateStr;
            } else {
              return String(dateStr);
            }

            if (isNaN(date.getTime())) {
              return dateStr; // return original if can't parse
            }

            // Format as DD.MM.YYYY HH:MM
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');

            return `${day}.${month}.${year} ${hours}:${minutes}`;
          } catch (e) {
            // If there's an error parsing the date, return the original string
            return dateStr;
          }
        };

        // Toast notification function
        const showToast = (message, type = 'info') => {
          // Create toast container if it doesn't exist
          let container = document.querySelector('.toast-container');
          if (!container) {
            container = document.createElement('div');
            container.className = 'toast-container';
            document.body.appendChild(container);
          }

          // Create toast element
          const toast = document.createElement('div');
          toast.className = `toast ${type}`;
          toast.innerHTML = `
            <div class="toast-content">${message}</div>
            <button class="toast-close" onclick="this.parentElement.remove()">‚úï</button>
          `;

          // Add to container
          container.appendChild(toast);

          // Auto remove after 5 seconds
          setTimeout(() => {
            if (toast.parentElement) {
              toast.remove();
            }
          }, 5000);
        };

        // Load conferences on component mount
        onMounted(async () => {
          // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å BX24 SDK
          const bx24Available = await initializeBX24();

          // –ü–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ BX24
          if (bx24Available) {
            try {
              currentUser.value = await getCurrentUserFromBX24();
              console.log('–¢–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:', currentUser.value);
            } catch (error) {
              console.error('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ BX24:', error);
              // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º —Ä–∞–±–æ—Ç—É –±–µ–∑ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)
            }
          }

          // –ó–∞–≥—Ä—É–∑–∏—Ç—å –∫–æ–Ω—Ñ–µ—Ä–µ–Ω—Ü–∏–∏
          loadConferences();

          // Close menus when clicking outside
          document.addEventListener('click', (e) => {
            if (openMenuId.value !== null) {
              closeMenu();
            }
            if (showCreateMenu.value) {
              showCreateMenu.value = false;
            }
          });

          // Close menu when scrolling
          window.addEventListener('scroll', () => {
            if (openMenuId.value !== null) {
              closeMenu();
            }
          }, true); // Use capture phase to catch all scroll events
        });

        return {
          searchQuery, selectedTab, isCreateModalOpen, showCreateMenu, loading, creatingConference,
          conferences, newConference, tabs, filteredConferences, openMenuId, menuPosition, selectedConf,
          statusColor, statusText, openCreateModal, closeModal,
          handleCreateConference, copyLink, deleteConference, tabCount,
          start, edit, addCohost, removeCohost, toggleMenu, closeMenu, editFromMenu, deleteFromMenu,
          bitrixAuth, telemostAuth, formatDate, showToast
        };
      }
    }).mount('#app');
  </script>
</body>
</html>