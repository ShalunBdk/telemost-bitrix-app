# --- В секцию Upstreams добавьте: ---

upstream backend_telemost_bitrix {
    server telemost-bitrix-app:5000;
}

server {
    listen 443 ssl;
    http2 on;
    server_name it.virtex-food.ru;

    # Telemost-Bitrix приложение
    location /telemost-bitrix/ {
        # Убираем /telemost-bitrix из пути перед передачей в приложение
        rewrite ^/telemost-bitrix/(.*) /$1 break;

        proxy_pass http://backend_telemost_bitrix/;

        proxy_set_header X-Script-Name /telemost-bitrix;

        # Отключаем буферизацию для лучшей работы с long-polling
        proxy_buffering off;
        proxy_request_buffering off;
    }

    # Статические файлы (кэширование)
    location /telemost-bitrix/static/ {
        rewrite ^/telemost-bitrix/static/(.*) /static/$1 break;
        proxy_pass http://backend_telemost_bitrix;

        proxy_set_header Host $host;
        proxy_cache_valid 200 1h;
        proxy_cache_bypass $http_pragma $http_authorization;
        expires 1h;
        add_header Cache-Control "public, immutable";
    }

    # Health check endpoint (без логирования)
    location /telemost-bitrix/health {
        rewrite ^/telemost-bitrix/health /health break;
        proxy_pass http://backend_telemost_bitrix;
        access_log off;
    }
}
